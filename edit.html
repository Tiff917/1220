<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- 1. 基礎設定 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #ffffff; color: #000; padding-bottom: 20px; }
        
        /* --- 2. 頂部導航 (參考截圖) --- */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; background: #fff; position: sticky; top: 0; z-index: 50;
        }
        .header-btn { font-size: 16px; color: #8e8e93; border: none; background: none; cursor: pointer; }
        .header-title { font-size: 17px; font-weight: 600; }
        .header-btn.finish { color: #be9f82; font-weight: 600; } /* 類似截圖的卡其金色 */

        /* --- 3. 主圖預覽區 (重點配色) --- */
        .main-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1; /* 正方形 */
            background-color: #f0f0f0;
            overflow: hidden;
        }
        
        #mainPreviewImg {
            width: 100%; height: 100%; object-fit: cover;
            display: none; /* 有圖才顯示 */
        }

        /* 浮動控制列 (參考截圖：半透明深色) */
        .overlay-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            left: 15px;
            display: flex;
            justify-content: flex-end; /* 靠右對齊 */
            align-items: center;
            gap: 10px;
            pointer-events: none; /* 讓點擊穿透容器，只點按鈕 */
        }

        /* 圓形按鈕 (朋友/地點) */
        .icon-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5); /* 半透明黑底 */
            backdrop-filter: blur(4px);
            border: none;
            display: flex; justify-content: center; align-items: center;
            color: white;
            pointer-events: auto;
            cursor: pointer;
        }

        /* 選取多張按鈕 (膠囊狀) */
        .select-multiple-btn {
            height: 36px;
            padding: 0 16px;
            border-radius: 20px;
            background: rgba(80, 70, 60, 0.75); /* 截圖中的深棕灰色 */
            backdrop-filter: blur(4px);
            border: none;
            color: white;
            font-size: 13px;
            font-weight: 600;
            display: flex; align-items: center; gap: 6px;
            pointer-events: auto;
            cursor: pointer;
            transition: background 0.2s;
        }
        .select-multiple-btn.active {
            background: #be9f82; /* 啟用時變亮 */
            color: #fff;
        }

        /* --- 4.下方照片網格 --- */
        .grid-gallery {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 一行 4 張 */
            gap: 2px;
            margin-top: 2px;
        }
        .grid-item {
            position: relative;
            aspect-ratio: 1/1;
            overflow: hidden;
            background: #eee;
            cursor: pointer;
        }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: opacity 0.2s; }
        
        /* 選中狀態 / 當前主圖狀態 */
        .grid-item.active img { opacity: 1; }
        .grid-item.selected .overlay { background: rgba(0,0,0,0.4); }
        
        /* 勾選圈圈 */
        .check-circle {
            position: absolute; top: 4px; right: 4px;
            width: 18px; height: 18px;
            border-radius: 50%; border: 2px solid white;
            background: rgba(0,0,0,0.3);
            display: none; /* 選取模式才顯示 */
        }
        .grid-item.selected .check-circle { background: #be9f82; border-color: #be9f82; }

        /* --- 5. 朋友標註列表 (隱藏式) --- */
        #friendSection {
            padding: 15px;
            background: white;
            display: none; /* 點擊 icon 才顯示 */
        }
        .friend-list { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }
        .friend-item { display: flex; flex-direction: column; align-items: center; min-width: 60px; cursor: pointer; }
        .avatar-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .friend-item.tagged .avatar-img { border-color: #be9f82; }
        .friend-name { font-size: 12px; margin-top: 4px; color: #666; }
        .friend-item.tagged .friend-name { color: #be9f82; font-weight: bold; }

        /* --- 其他 --- */
        .empty-state {
            height: 60vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999;
        }
        .upload-trigger {
            padding: 10px 20px; background: #eee; border-radius: 20px; margin-top: 10px; cursor: pointer; font-weight: 500;
        }
        #locationInput { display: none; width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; }
        
        /* 隱藏 Canvas */
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <button class="header-btn" onclick="history.back()">Back</button>
        <div class="header-title">Post</div>
        <button class="header-btn finish" id="shareBtn">Finish</button>
    </div>

    <div id="contentArea">
        
        <div id="placeholder" class="empty-state">
            <i data-lucide="image" size="48"></i>
            <label class="upload-trigger">
                Open Gallery
                <input type="file" id="imageLoader" accept="image/*" multiple style="display: none;">
            </label>
        </div>

        <div id="editorSection" style="display: none;">
            
            <div class="main-preview-container">
                <img id="mainPreviewImg" src="" alt="Preview">
                
                <div class="overlay-controls">
                    <button class="icon-btn" id="tagFriendBtn">
                        <i data-lucide="user-plus" size="18"></i>
                    </button>
                    <button class="icon-btn" id="locationBtn">
                        <i data-lucide="map-pin" size="18"></i>
                    </button>
                    <button class="select-multiple-btn" id="multiSelectBtn">
                        <i data-lucide="layers" size="16"></i>
                        SELECT MULTIPLE
                    </button>
                </div>
            </div>

            <input type="text" id="locationInput" placeholder="Add location...">

            <div id="friendSection">
                <p style="font-size:12px; color:#999; margin-bottom:10px;">Tag Friends:</p>
                <div class="friend-list" id="friendListContainer"></div>
            </div>

            <div class="grid-gallery" id="gridGallery"></div>
        </div>
    </div>

    <canvas id="compressCanvas"></canvas>

    <script>
        // 初始化 Icons
        lucide.createIcons();

        // --- Database Setup ---
        const dbName = "MemoriesDB";
        let db;

        // 我們需要同時寫入兩個 Store:
        // 1. posts_timeline (給 Social.html 用)
        // 2. all_photos (給 Memories.html 用)
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 2); // 確保版本號足夠
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    // Social Store
                    if (!db.objectStoreNames.contains("posts_timeline")) {
                        db.createObjectStore("posts_timeline", { keyPath: "id" });
                    }
                    // Memories Store
                    if (!db.objectStoreNames.contains("all_photos")) {
                        db.createObjectStore("all_photos", { autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        // --- DOM Elements ---
        const imageLoader = document.getElementById('imageLoader');
        const placeholder = document.getElementById('placeholder');
        const editorSection = document.getElementById('editorSection');
        const mainPreviewImg = document.getElementById('mainPreviewImg');
        const gridGallery = document.getElementById('gridGallery');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const shareBtn = document.getElementById('shareBtn');
        const friendSection = document.getElementById('friendSection');
        const friendListContainer = document.getElementById('friendListContainer');
        const locationInput = document.getElementById('locationInput');
        const compressCanvas = document.getElementById('compressCanvas');
        const ctx = compressCanvas.getContext('2d');

        // --- State ---
        let pendingImages = []; // Array of Base64 strings
        let selectedIndices = []; // Indices selected for posting
        let isSelectMode = false;
        let taggedFriendIds = [];
        let currentMainIndex = 0; // 當前大圖顯示哪一張

        // 模擬朋友資料
        const friendsData = [
            { id: 1, name: 'Alice', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Alice' },
            { id: 2, name: 'Bob', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Bob' },
            { id: 3, name: 'Charlie', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Charlie' },
            { id: 4, name: 'David', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=David' }
        ];

        // --- Logic: 圖片處理 ---
        imageLoader.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // 簡單Loading
            placeholder.innerHTML = "Processing...";
            
            pendingImages = [];
            for (const file of files) {
                const base64 = await processImage(file);
                pendingImages.push(base64);
            }

            if (pendingImages.length > 0) {
                placeholder.style.display = 'none';
                editorSection.style.display = 'block';
                // 預設選取全部
                selectedIndices = pendingImages.map((_, i) => i);
                currentMainIndex = 0;
                
                renderMainPreview();
                renderGrid();
                renderFriends();
            }
        });

        function processImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        const max = 1080;
                        if (w > max || h > max) {
                            if (w > h) { h *= max/w; w = max; }
                            else { w *= max/h; h = max; }
                        }
                        compressCanvas.width = w; compressCanvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(compressCanvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- Logic: 渲染 ---
        function renderMainPreview() {
            if (pendingImages[currentMainIndex]) {
                mainPreviewImg.style.display = 'block';
                mainPreviewImg.src = pendingImages[currentMainIndex];
            }
        }

        function renderGrid() {
            gridGallery.innerHTML = pendingImages.map((src, idx) => {
                const isSelected = selectedIndices.includes(idx);
                const isActive = (idx === currentMainIndex);
                
                // 多選模式下顯示勾勾
                const checkCircle = isSelectMode 
                    ? `<div class="check-circle" style="display:block; ${isSelected ? 'background:#be9f82; border-color:#be9f82;' : ''}"></div>` 
                    : '';

                return `
                    <div class="grid-item ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="handleGridClick(${idx})">
                        <img src="${src}">
                        ${checkCircle}
                    </div>
                `;
            }).join('');
        }

        function renderFriends() {
            friendListContainer.innerHTML = friendsData.map(f => {
                const isTagged = taggedFriendIds.includes(f.id);
                return `
                    <div class="friend-item ${isTagged ? 'tagged' : ''}" onclick="toggleFriend(${f.id})">
                        <img class="avatar-img" src="${f.avatar}">
                        <span class="friend-name">${f.name}</span>
                    </div>
                `;
            }).join('');
        }

        // --- Logic: 互動 ---
        
        // 點擊網格照片
        window.handleGridClick = (idx) => {
            if (isSelectMode) {
                // 多選模式：切換選取狀態
                if (selectedIndices.includes(idx)) {
                    selectedIndices = selectedIndices.filter(i => i !== idx);
                } else {
                    selectedIndices.push(idx);
                }
                renderGrid();
            } else {
                // 一般模式：切換大圖預覽
                currentMainIndex = idx;
                renderMainPreview();
                renderGrid();
            }
        };

        // 切換多選模式
        multiSelectBtn.addEventListener('click', () => {
            isSelectMode = !isSelectMode;
            multiSelectBtn.classList.toggle('active', isSelectMode);
            renderGrid(); // 更新網格顯示勾勾
        });

        // 標註朋友與地點 (顯示/隱藏區域)
        document.getElementById('tagFriendBtn').addEventListener('click', () => {
            friendSection.style.display = friendSection.style.display === 'none' ? 'block' : 'none';
        });
        document.getElementById('locationBtn').addEventListener('click', () => {
            locationInput.style.display = locationInput.style.display === 'none' ? 'block' : 'none';
            if(locationInput.style.display === 'block') locationInput.focus();
        });

        window.toggleFriend = (id) => {
            if (taggedFriendIds.includes(id)) taggedFriendIds = taggedFriendIds.filter(tid => tid !== id);
            else taggedFriendIds.push(id);
            renderFriends();
        };

        // --- Logic: 同步儲存與跳轉 (核心需求) ---
        shareBtn.addEventListener('click', async () => {
            // 1. 過濾出要發布的照片
            const imagesToPost = pendingImages.filter((_, i) => selectedIndices.includes(i));
            if (imagesToPost.length === 0) {
                alert("Please select at least one photo.");
                return;
            }

            shareBtn.textContent = "Posting...";
            
            if (!db) await initDB();

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            
            // 2. 準備 Post 資料 (給 Social.html)
            const newPost = {
                id: Date.now(),
                timestamp: now.getTime(),
                dateString: dateStr,
                images: imagesToPost, // 陣列
                location: locationInput.value || null,
                taggedFriends: taggedFriendIds,
                likes: 0,
                comments: []
            };

            // 3. 準備 Memories 資料 (給 Memories.html)
            // Memories 通常是單張照片的集合，我們把這次選的每張照片都存進去
            // 如果 Memories 需要依照日期分組，它讀取時可以用 dateString 分組
            const memoryItems = imagesToPost.map(imgBase64 => ({
                date: dateStr,
                timestamp: now.getTime(),
                image: imgBase64
            }));

            // 4. 開始交易 (Transaction) - 同時寫入兩個 Object Store
            // 注意：要寫入兩個 store，transaction 必須包含這兩個 store name
            const tx = db.transaction(["posts_timeline", "all_photos"], "readwrite");
            
            // 寫入 Social
            const socialStore = tx.objectStore("posts_timeline");
            socialStore.add(newPost);

            // 寫入 Memories (迴圈寫入每一張)
            const memoriesStore = tx.objectStore("all_photos");
            memoryItems.forEach(item => {
                memoriesStore.add(item);
            });

            // 5. 交易完成後的動作
            tx.oncomplete = () => {
                console.log("Saved to Social and Memories!");
                // 跳轉回首頁
                window.location.href = "home.html";
            };

            tx.onerror = (err) => {
                console.error("Transaction failed", err);
                alert("Failed to post.");
                shareBtn.textContent = "Finish";
            };
        });

        initDB();
    </script>
</body>
</html>
