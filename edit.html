<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <style>
        /* --- 全局設定 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #fff; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 頂部導航 --- */
        .header {
            flex-shrink: 0; height: 50px; padding: 0 16px; margin-top: 40px; /* 避開瀏海 */
            display: flex; justify-content: space-between; align-items: center;
            background-color: #fff; 
            z-index: 10;
        }

        .header-btn { font-size: 17px; font-weight: 600; text-decoration: none; cursor: pointer; border: none; background: none; }
        .cancel-btn { color: #000; }
        .title { font-size: 17px; font-weight: 700; color: #000; }
        .next-btn { color: #0095f6; } /* IG 藍 */
        .next-btn:disabled { color: #b3dbff; }

        /* --- 預覽區域 (上半部) --- */
        .preview-container {
            width: 100%;
            aspect-ratio: 1 / 1; /* 正方形預覽 */
            background-color: #f0f0f0;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        #mainPreview {
            width: 100%; height: 100%; object-fit: cover;
            transition: opacity 0.2s;
        }

        /* --- 浮動功能列 (Tag, Location, Multiple) --- */
        .overlay-bar {
            position: absolute; bottom: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .left-actions { display: flex; gap: 8px; }

        /* 圓形按鈕樣式 */
        .overlay-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 20px;
            height: 32px;
            padding: 0 12px;
            border: none;
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; font-weight: 600;
            backdrop-filter: blur(4px);
            cursor: pointer;
        }
        
        .circle-icon-btn {
            width: 32px; height: 32px; padding: 0; justify-content: center; border-radius: 50%;
        }

        .overlay-btn.active {
            background: #0095f6; /* 啟用時變藍色 */
            color: white;
        }
        
        .overlay-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* --- 下方相簿網格 (Gallery) --- */
        .gallery-scroll {
            flex: 1; overflow-y: auto; background: #fff;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4欄 */
            gap: 2px;
            padding-top: 2px;
        }

        .gallery-item {
            aspect-ratio: 1 / 1;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .gallery-item img {
            width: 100%; height: 100%; object-fit: cover;
            display: block;
            transition: opacity 0.2s;
        }

        /* 選取時的遮罩與樣式 */
        .gallery-item.selected img {
            opacity: 0.4; /* 被選中時變暗 */
        }
        
        /* 選取時的編號圈圈 */
        .selection-badge {
            position: absolute; top: 8px; right: 8px;
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 600; color: white;
            z-index: 2;
        }

        .gallery-item.selected .selection-badge {
            background: #0095f6;
            border-color: #0095f6;
        }
        
        /* 隱藏原生檔案輸入 */
        #hiddenFileInput { display: none; }
        
        /* 載入更多按鈕 (模擬相簿) */
        .load-more-placeholder {
            grid-column: 1 / -1;
            padding: 20px; text-align: center; color: #999; font-size: 14px;
        }

    </style>
</head>
<body>

    <div class="header">
        <a href="home.html" class="header-btn cancel-btn">Back</a>
        <div class="title">New Post</div>
        <button class="header-btn next-btn" id="nextBtn">Share</button>
    </div>

    <div class="preview-container">
        <img id="mainPreview" src="" alt="">

        <div class="overlay-bar">
            <div class="left-actions">
                <button class="overlay-btn circle-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </button>
                <button class="overlay-btn circle-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                </button>
            </div>

            <button class="overlay-btn" id="multiSelectBtn" onclick="toggleMultiSelect()">
                <svg style="margin-right:4px;" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-2h-2v-2h2v-2h2v2h2v2zm-4-6V7H5v10h12v-2h2v4H3V5h16v6h-2z"></path></svg>
                SELECT MULTIPLE
            </button>
        </div>
    </div>

    <div class="gallery-scroll">
        <input type="file" id="hiddenFileInput" accept="image/*" multiple>
        
        <div style="padding: 2px;">
            <div onclick="document.getElementById('hiddenFileInput').click()" style="background:#efefef; padding:10px; text-align:center; font-weight:600; color:#666; cursor:pointer;">
                + Open Phone Gallery
            </div>
        </div>

        <div class="gallery-grid" id="galleryGrid">
            </div>
    </div>

    <script>
        // --- 1. IndexedDB 設定 ---
        const dbName = "MemoriesDB";
        const storeName = "photos";
        const channel = new BroadcastChannel('memory_update'); 
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        function getAllMemories() {
            return new Promise((resolve) => {
                if (!db) return resolve({});
                const tx = db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get("all_photos");
                req.onsuccess = (e) => resolve(e.target.result || {});
                req.onerror = () => resolve({});
            });
        }

        function saveAllMemories(data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const store = tx.objectStore(storeName);
                const req = store.put(data, "all_photos");
                req.onsuccess = () => resolve();
                req.onerror = () => reject();
            });
        }

        // --- 2. 應用程式邏輯 ---
        
        // 模擬一些預設照片 (為了讓介面看起來像相簿，你可以刪除這些 URL)
        let galleryImages = [
            "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300",
            "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=300",
            "https://images.unsplash.com/photo-1482049016688-2d3e1b311543?w=300",
            "https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=300",
            "https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=300",
        ];

        let selectedIndices = new Set(); // 存被選中的照片索引 (針對 galleryImages)
        let uploadedFiles = []; // 存使用者真正上傳的 File 物件
        let isMultiSelect = false;

        const mainPreview = document.getElementById('mainPreview');
        const galleryGrid = document.getElementById('galleryGrid');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const fileInput = document.getElementById('hiddenFileInput');
        const nextBtn = document.getElementById('nextBtn');

        // 初始化：預設顯示第一張
        mainPreview.src = galleryImages[0];
        renderGallery();

        // --- 處理真實檔案上傳 (合併到相簿清單) ---
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;

            // 將新上傳的檔案轉為 Blob URL 並加入 galleryImages 最前面
            files.reverse().forEach(file => {
                const blobUrl = URL.createObjectURL(file);
                // 加到陣列最前面
                galleryImages.unshift(blobUrl);
                // 也要儲存原始 File 物件以便後續壓縮處理 (這裡為了簡化，我們用 URL 處理)
            });

            // 重新渲染並選中第一張
            renderGallery();
            selectImage(0); 
        });

        // --- 渲染相簿網格 ---
        function renderGallery() {
            galleryGrid.innerHTML = "";
            
            galleryImages.forEach((url, index) => {
                const item = document.createElement('div');
                item.className = `gallery-item ${selectedIndices.has(index) ? 'selected' : ''}`;
                
                // 圖片
                const img = document.createElement('img');
                img.src = url;
                
                // 選取狀態 (如果多選模式，顯示數字；單選模式不顯示)
                const badge = document.createElement('div');
                badge.className = 'selection-badge';
                
                // 計算這是第幾個被選中的
                if (selectedIndices.has(index)) {
                    const order = Array.from(selectedIndices).indexOf(index) + 1;
                    badge.textContent = order;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                // 點擊事件
                item.onclick = () => handleItemClick(index);

                item.appendChild(img);
                item.appendChild(badge);
                galleryGrid.appendChild(item);
            });
        }

        // --- 切換多選模式 ---
        function toggleMultiSelect() {
            isMultiSelect = !isMultiSelect;
            
            if (isMultiSelect) {
                multiSelectBtn.classList.add('active');
                // 進入多選時，預設選中當前預覽的那張
                // 找出當前預覽圖在陣列中的 index
                const currentSrc = mainPreview.src;
                const idx = galleryImages.indexOf(currentSrc);
                if(idx !== -1 && selectedIndices.size === 0) {
                    selectedIndices.add(idx);
                }
            } else {
                multiSelectBtn.classList.remove('active');
                // 離開多選時，保留最後一張作為單選，清空 Set
                const lastSelected = Array.from(selectedIndices).pop();
                selectedIndices.clear();
                if (lastSelected !== undefined) {
                    // 保持預覽圖不變
                }
            }
            renderGallery();
        }

        // --- 點擊照片邏輯 ---
        function handleItemClick(index) {
            const url = galleryImages[index];

            if (isMultiSelect) {
                // 多選模式
                if (selectedIndices.has(index)) {
                    selectedIndices.delete(index);
                    // 如果取消選取的是當前預覽圖，則預覽圖切換到上一張選取的，或維持不變
                } else {
                    selectedIndices.add(index);
                    mainPreview.src = url; // 點擊的變成預覽圖
                }
                renderGallery();
            } else {
                // 單選模式
                mainPreview.src = url;
                // 視覺上不做 selected class，因為單選模式通常只是換預覽
                // 但為了邏輯一致，我們可以清空 Set 並加入這張
                selectedIndices.clear();
                selectedIndices.add(index);
                // 重新渲染以移除其他人的勾勾
                renderGallery(); 
            }
        }

        function selectImage(index) {
            mainPreview.src = galleryImages[index];
            if(isMultiSelect) {
                selectedIndices.add(index);
            } else {
                selectedIndices.clear();
                selectedIndices.add(index);
            }
            renderGallery();
        }

        // --- 3. Share 存檔邏輯 (支援多張) ---
        nextBtn.addEventListener('click', async () => {
            // 決定要存哪些圖
            let finalImagesToSave = [];

            if (selectedIndices.size > 0) {
                // 如果有選取，依照選取順序存
                selectedIndices.forEach(idx => {
                    finalImagesToSave.push(galleryImages[idx]);
                });
            } else {
                // 如果沒特別選 (且不在多選模式)，就存當前預覽的那張
                finalImagesToSave.push(mainPreview.src);
            }

            if(finalImagesToSave.length === 0) return;

            nextBtn.textContent = "Sharing...";
            nextBtn.style.opacity = "0.5";

            // 初始化 DB
            if (!db) await initDB();
            let memories = await getAllMemories();

            const now = new Date();
            const dateKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;

            if (!memories[dateKey]) memories[dateKey] = [];
            if (!Array.isArray(memories[dateKey])) memories[dateKey] = [memories[dateKey]];

            // 處理圖片轉換 (URL -> Base64) 並儲存
            // 注意：因為 galleryImages 可能是 blob URL 或外部 URL，我們需要轉成 base64 存 DB 比較保險
            let processedCount = 0;
            
            for (let url of finalImagesToSave) {
                try {
                    const base64 = await urlToBase64(url);
                    memories[dateKey].push(base64);
                } catch (e) {
                    console.error("Image conversion failed", e);
                }
            }

            try {
                await saveAllMemories(memories);
                channel.postMessage('updated');
                window.location.href = "home.html";
            } catch (err) {
                console.error(err);
                alert("Storage full or error.");
                nextBtn.textContent = "Share";
                nextBtn.style.opacity = "1";
            }
        });

        // 輔助函式：將圖片 URL 轉 Base64 (以便存入 IndexedDB)
        function urlToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // 簡單壓縮
                    let w = img.width;
                    let h = img.height;
                    const max = 1024;
                    if(w > max) { h*=max/w; w=max; }
                    
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = reject;
                img.src = url;
            });
        }

        initDB();

    </script>
</body>
</html>
        initDB();
    </script>
</body>
</html>
