<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- 1. 基礎設定 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #ffffff; color: #000; padding-bottom: 20px; }
        
        /* --- 2. 頂部導航 --- */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; background: #fff; position: sticky; top: 0; z-index: 50;
        }
        .header-btn { font-size: 16px; color: #8e8e93; border: none; background: none; cursor: pointer; }
        .header-title { font-size: 17px; font-weight: 600; }
        .header-btn.finish { color: #be9f82; font-weight: 600; } 

        /* --- 3. 主圖預覽區 --- */
        .main-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1; 
            background-color: #f9f9f9; /* 稍微改淺一點的灰 */
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        
        #mainPreviewImg {
            width: 100%; height: 100%; object-fit: cover;
            transition: opacity 0.2s;
            display: none; /* 預設隱藏，等有圖再顯示 */
        }
        
        /* 當沒有選取任何照片時顯示的提示 */
        .empty-placeholder {
            color: #ccc; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }

        .overlay-controls {
            position: absolute; bottom: 15px; right: 15px; left: 15px;
            display: flex; justify-content: flex-end; align-items: center; gap: 10px;
            pointer-events: none; 
        }

        /* --- 按鈕樣式 --- */
        .control-btn {
            height: 36px; border: none; color: white;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px);
            pointer-events: auto; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .btn-circle { width: 36px; border-radius: 50%; padding: 0; }
        .btn-capsule { padding: 0 16px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        
        /* Icon 縮小 */
        .control-btn svg { width: 13px !important; height: 13px !important; }

        .btn-text { font-size: 13px; font-weight: 600; margin-left: 0; max-width: 0; opacity: 0; white-space: nowrap; transition: all 0.3s ease; }
        .btn-capsule .btn-text-static { font-size: 12px; font-weight: 600; margin-left: 6px; }

        .control-btn.active { background: #be9f82; color: #fff; }
        #locationBtn.active { width: auto; padding: 0 16px; border-radius: 20px; }
        #locationBtn.active .btn-text { max-width: 100px; opacity: 1; margin-left: 6px; }

        /* --- 4. 下方網格 --- */
        .grid-gallery {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-top: 2px;
        }
        .grid-item {
            position: relative; aspect-ratio: 1/1; overflow: hidden; background: #eee; cursor: pointer;
        }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: opacity 0.2s; }
        .grid-item.active img { opacity: 1; }

        /* ★★★ 相簿/新增按鈕樣式 (第一格) ★★★ */
        .camera-upload-item {
            background-color: #f0f0f0;
            display: flex; align-items: center; justify-content: center;
            color: #999;
            cursor: pointer;
        }
        .camera-upload-item:active { background-color: #e0e0e0; }
        .camera-upload-item svg { width: 24px; height: 24px; } /* 這個 icon 可以大一點點 */

        /* 遮罩 */
        .overlay-mask {
            position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: none;
        }
        .grid-item.selected .overlay-mask { display: block; }

        /* 圈圈 */
        .check-circle {
            position: absolute; top: 6px; right: 6px;
            width: 22px; height: 22px;
            border-radius: 50%; 
            z-index: 10;
            display: none; 
            border: 2px solid rgba(255, 255, 255, 0.9);
            background-color: rgba(0, 0, 0, 0.2); 
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
            justify-content: center; align-items: center;
            font-size: 11px; font-weight: 700; color: white;
            transition: transform 0.1s ease;
        }
        .grid-item.mode-select .check-circle { display: flex; }
        .grid-item.selected .check-circle {
            background-color: #be9f82; border-color: #be9f82; transform: scale(1.1);     
        }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <button class="header-btn" onclick="history.back()">Back</button>
        <div class="header-title">Post</div>
        <button class="header-btn finish" id="shareBtn">Finish</button>
    </div>

    <div id="contentArea">
        <div class="main-preview-container">
            <div id="emptyPlaceholder" class="empty-placeholder">
                <i data-lucide="image" style="width:48px; height:48px; opacity:0.2;"></i>
            </div>
            
            <img id="mainPreviewImg" src="" alt="Preview">
            
            <div class="overlay-controls">
                <button class="control-btn btn-circle" id="tagFriendBtn"><i data-lucide="user"></i></button>
                <button class="control-btn btn-circle" id="locationBtn"><i data-lucide="map-pin"></i><span class="btn-text">Kaohsiung</span></button>
                <button class="control-btn btn-capsule" id="multiSelectBtn"><i data-lucide="layers"></i><span class="btn-text-static">SELECT MULTIPLE</span></button>
            </div>
        </div>
        
        <div class="grid-gallery" id="gridGallery">
            </div>
        
        <input type="file" id="imageLoader" accept="image/*" multiple style="display: none;">
    </div>

    <div class="danger-zone">
        <div id="statusLog" class="status-log">System Ready...</div>
        <button class="reset-btn" onclick="hardReset()">⚠️ 點我修復資料庫 (Fix DB)</button>
        <p style="font-size:12px; color:#999; margin-top:5px;">如果還是跑不動，請點上面紅色按鈕重置</p>
    </div>
    <canvas id="compressCanvas"></canvas>
<script>
lucide.createIcons();
        const dbName = "MemoriesDB";
        let db;
        const statusLog = document.getElementById('statusLog');

        function log(msg) {
            console.log(msg);
            statusLog.innerHTML += `<div>${msg}</div>`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // --- 強制修復功能 (更加強力) ---
        async function hardReset() {
            if(!confirm("這會清除所有暫存資料並修復卡住的問題，確定嗎？")) return;
            log("Closing DB connection...");
            if(db) { db.close(); db = null; }
            
            log("Deleting Database...");
            const req = indexedDB.deleteDatabase(dbName);
            
            req.onsuccess = () => {
                alert("資料庫已重置！頁面將重新整理。");
                location.reload();
            };
            
            req.onerror = (e) => {
                log("Delete Error: " + e.target.error);
                alert("無法刪除，請嘗試「關閉所有分頁」後重開瀏覽器。");
            };
            
            req.onblocked = () => {
                log("Delete Blocked! Close other tabs.");
                alert("重置被阻擋！請關閉其他所有開啟此網站的分頁 (Home, Social 等)。");
            };
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                // 使用版本號 5，再次強制觸發更新
                const request = indexedDB.open(dbName, 5);
                
                // ★★★ 防止卡死關鍵：監聽 blocked 事件 ★★★
                request.onblocked = (e) => {
                    log("Database Blocked! Please close other tabs.");
                    alert("資料庫被鎖定！\n請關閉您瀏覽器中其他開啟本網站的分頁 (Home, Social)，然後重新整理此頁。");
                };

                request.onupgradeneeded = (e) => {
                    log("Upgrading DB Structure...");
                    db = e.target.result;
                    // 如果倉庫不存在就建立
                    if (!db.objectStoreNames.contains("posts_timeline")) {
                        db.createObjectStore("posts_timeline", { keyPath: "id" });
                    }
                    if (!db.objectStoreNames.contains("all_photos")) {
                        db.createObjectStore("all_photos", { autoIncrement: true });
                    }
                };

                request.onsuccess = (e) => { 
                    db = e.target.result; 
                    
                    // ★★★ 二次檢查：確保倉庫真的存在 ★★★
                    if (!db.objectStoreNames.contains("posts_timeline") || !db.objectStoreNames.contains("all_photos")) {
                        log("Store missing! Resetting...");
                        // 如果版本對了但倉庫不見了，強制重置
                        db.close();
                        hardReset();
                        return;
                    }

                    log("DB Connected Successfully."); 
                    resolve(db); 
                };

                request.onerror = (e) => {
                    log("DB Open Error: " + e.target.error);
                    reject(e);
                };
            });
        }

        const mainPreviewImg = document.getElementById('mainPreviewImg');
        const emptyPlaceholder = document.getElementById('emptyPlaceholder');
        const gridGallery = document.getElementById('gridGallery');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const tagFriendBtn = document.getElementById('tagFriendBtn');
        const locationBtn = document.getElementById('locationBtn');
        const shareBtn = document.getElementById('shareBtn');
        const imageLoader = document.getElementById('imageLoader');
        const compressCanvas = document.getElementById('compressCanvas');
        const ctx = compressCanvas.getContext('2d');

        let pendingImages = [];
        let selectedIndices = [];
        let isSelectMode = false;
        let isFriendTagged = false;
        let currentLocation = null;
        let currentMainIndex = -1;

        // 頁面關閉時釋放連線，避免卡死其他頁面
        window.onunload = () => {
            if(db) db.close();
        };

        window.onload = () => { renderGrid(); };

        imageLoader.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            log(`Processing ${files.length} images...`);
            emptyPlaceholder.innerHTML = "Processing...";

            for (const file of files) {
                try {
                    const base64 = await processImage(file);
                    pendingImages.push(base64);
                } catch (err) { log("Error processing image"); }
            }

            emptyPlaceholder.innerHTML = '<i data-lucide="image" style="width:48px; height:48px; opacity:0.2;"></i>';
            lucide.createIcons();

            const newIndex = pendingImages.length - 1;
            currentMainIndex = newIndex;
            if (!isSelectMode) selectedIndices = [newIndex];
            
            renderMainPreview();
            renderGrid();
            log("Images ready.");
        });

        function processImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        // 維持極小尺寸以確保成功
                        const max = 450; 
                        if (w > max || h > max) {
                           if (w > h) { h *= max/w; w = max; } else { w *= max/h; h = max; }
                        }
                        compressCanvas.width = w; compressCanvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        // 品質 0.5
                        resolve(compressCanvas.toDataURL('image/jpeg', 0.5));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function renderMainPreview() {
            if (currentMainIndex !== -1 && pendingImages[currentMainIndex]) {
                emptyPlaceholder.style.display = 'none';
                mainPreviewImg.style.display = 'block';
                mainPreviewImg.src = pendingImages[currentMainIndex];
            } else {
                emptyPlaceholder.style.display = 'flex';
                mainPreviewImg.style.display = 'none';
            }
        }

        function renderGrid() {
            let html = `
                <div class="grid-item camera-upload-item" onclick="document.getElementById('imageLoader').click()">
                    <i data-lucide="image-plus"></i>
                </div>
            `;
            html += pendingImages.map((src, idx) => {
                const isActive = (idx === currentMainIndex);
                const selectionIndex = selectedIndices.indexOf(idx);
                const isSelected = selectionIndex !== -1;
                const selectionNumber = isSelected ? selectionIndex + 1 : '';
                let classes = `grid-item ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}`;
                if (isSelectMode) classes += ' mode-select';
                return `
                    <div class="${classes}" onclick="handleGridClick(${idx})">
                        <img src="${src}">
                        <div class="overlay-mask"></div>
                        <div class="check-circle">${selectionNumber}</div>
                    </div>
                `;
            }).join('');
            gridGallery.innerHTML = html;
            lucide.createIcons();
        }

        window.handleGridClick = (idx) => {
            currentMainIndex = idx;
            renderMainPreview();
            if (isSelectMode) {
                const existingIndex = selectedIndices.indexOf(idx);
                if (existingIndex !== -1) selectedIndices.splice(existingIndex, 1);
                else selectedIndices.push(idx);
            } else {
                selectedIndices = [idx];
            }
            renderGrid();
        };

        tagFriendBtn.addEventListener('click', () => {
            isFriendTagged = !isFriendTagged;
            tagFriendBtn.classList.toggle('active', isFriendTagged);
        });

        locationBtn.addEventListener('click', () => {
            if (currentLocation) {
                currentLocation = null;
                locationBtn.classList.remove('active');
            } else {
                locationBtn.style.opacity = "0.7";
                setTimeout(() => {
                    currentLocation = "Kaohsiung";
                    locationBtn.style.opacity = "1";
                    locationBtn.classList.add('active');
                }, 500);
            }
        });

        multiSelectBtn.addEventListener('click', () => {
            if (pendingImages.length === 0) return;
            isSelectMode = !isSelectMode;
            multiSelectBtn.classList.toggle('active', isSelectMode);
            if (isSelectMode && currentMainIndex !== -1) selectedIndices = [currentMainIndex];
            else if (!isSelectMode && currentMainIndex !== -1) selectedIndices = [currentMainIndex];
            renderGrid();
        });

        // --- 儲存與發布 ---
        shareBtn.addEventListener('click', async () => {
            if (pendingImages.length === 0) { alert("Please add photos first."); return; }
            if (selectedIndices.length === 0) { alert("Please select at least one photo."); return; }

            shareBtn.disabled = true;
            shareBtn.textContent = "Processing...";
            log("Start saving process...");

            // 5秒保護機制
            const timeoutId = setTimeout(() => {
                alert("儲存逾時！資料庫可能被鎖死。\n1. 請關閉其他分頁\n2. 點擊下方紅色按鈕重置");
                shareBtn.disabled = false;
                shareBtn.textContent = "Finish";
            }, 5000);

            try {
                if (!db) await initDB();

                const now = new Date();
                const dateStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
                const imagesToPost = selectedIndices.map(i => pendingImages[i]);
                
                const newPost = {
                    id: Date.now(), timestamp: now.getTime(), dateString: dateStr,
                    images: imagesToPost, location: currentLocation, isFriendTagged: isFriendTagged,
                    likes: 0, comments: []
                };

                // 開啟交易
                const tx = db.transaction(["posts_timeline", "all_photos"], "readwrite");
                
                // 寫入 Social Store
                tx.objectStore("posts_timeline").add(newPost);
                
                // 寫入 Memories Store
                const memoriesStore = tx.objectStore("all_photos");
                imagesToPost.forEach(imgUrl => {
                    memoriesStore.add({
                        date: dateStr, timestamp: now.getTime(), image: imgUrl
                    });
                });

                tx.oncomplete = () => {
                    clearTimeout(timeoutId);
                    log("Save Complete!");
                    // 成功後跳轉
                    window.location.href = "home.html";
                };

                tx.onerror = (e) => {
                    clearTimeout(timeoutId);
                    log("TX Error: " + e.target.error);
                    alert("儲存錯誤: " + e.target.error.message);
                    shareBtn.disabled = false;
                    shareBtn.textContent = "Finish";
                };

            } catch (err) {
                clearTimeout(timeoutId);
                log("Fatal Error: " + err.message);
                alert("系統錯誤: " + err.message);
                shareBtn.disabled = false;
                shareBtn.textContent = "Finish";
            }
        });

        // 初始化
        initDB().catch(e => console.error(e));
</script>
</body>
</html>
