<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <style>
        /* --- 全局設定 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #F3ECE5;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- 頂部導航 --- */
        .header {
            flex-shrink: 0; height: 50px; padding: 0 16px; margin-top: 40px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: #F3ECE5; 
            z-index: 10;
        }

        .header-btn { font-size: 16px; font-weight: 600; text-decoration: none; cursor: pointer; border: none; background: none; }
        .cancel-btn { color: #6D5D55; }
        .title { font-size: 18px; font-weight: 700; color: #6D5D50; }
        .next-btn { color: #9C7C66; font-weight: 700; }
        .next-btn:disabled { color: #D6CCC2; }

        /* --- 預覽區域 --- */
        .preview-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #E3D5CA;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        #mainPreview {
            width: 100%; height: 100%; object-fit: cover;
            transition: opacity 0.2s;
            display: none; 
        }

        /* --- 浮動功能列 --- */
        .overlay-bar {
            position: absolute; bottom: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 5;
            pointer-events: none; 
        }
        .overlay-bar > * { pointer-events: auto; } 

        .left-actions { display: flex; gap: 8px; align-items: center; }

        /* 按鈕樣式 */
        .overlay-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 20px;
            height: 32px;
            padding: 0 12px;
            border: none;
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; font-weight: 600;
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .circle-icon-btn {
            width: 32px; padding: 0; justify-content: center; border-radius: 50%;
        }

        /* 啟用狀態 */
        .overlay-btn.active {
            background: #9C7C66; 
            color: white;
        }
        
        .overlay-btn svg { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }

        /* 地點文字樣式 */
        .location-text {
            opacity: 0; max-width: 0; transition: all 0.3s ease;
        }
        #btnLocation.active .location-text {
            opacity: 1; max-width: 100px; margin-left: 4px;
        }

        /* 載入動畫 */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .overlay-btn.loading svg { animation: pulse 1s infinite ease-in-out; }


        /* --- 下方相簿網格 (修改重點 4) --- */
        .gallery-scroll {
            flex: 1; overflow-y: auto; background: #F3ECE5;
        }

        /* 3欄網格 */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 2px;
            padding: 2px;
        }

        .gallery-item {
            aspect-ratio: 1 / 1;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-color: #E3D5CA;
        }

        .gallery-item img {
            width: 100%; height: 100%; object-fit: cover;
            display: block; transition: opacity 0.2s;
        }

        /* 修正：上傳按鈕方塊樣式 */
        .upload-tile {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #EBE1D7; 
            color: #9C7C66;
            font-size: 13px; font-weight: 700; gap: 5px;
            text-align: center;
            cursor: pointer;
        }
        .upload-tile svg { width: 28px; height: 28px; stroke-width: 2; }
        .upload-tile:active { background-color: #dccbc0; }

        /* 選取樣式 */
        .gallery-item.selected img { opacity: 0.5; }
        
        .selection-badge {
            position: absolute; top: 6px; right: 6px; width: 22px; height: 22px;
            border-radius: 50%; border: 2px solid #F3ECE5;
            background: rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 700; color: white; z-index: 2;
            transition: transform 0.1s;
        }

        .gallery-item.selected .selection-badge {
            background: #9C7C66; border-color: #F3ECE5; transform: scale(1.1);
        }
        
        #hiddenFileInput { display: none; }
        
    </style>
</head>
<body>

    <div class="header">
        <a href="home.html" class="header-btn cancel-btn">Cancel</a>
        <div class="title">New Post</div>
        <button class="header-btn next-btn" id="nextBtn">Share</button>
    </div>

    <div class="preview-container">
        <img id="mainPreview" src="" alt="">

        <div class="overlay-bar">
            <div class="left-actions">
                <button id="btnTagPeople" class="overlay-btn circle-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </button>
                <button id="btnLocation" class="overlay-btn circle-icon-btn" style="width: auto;">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                    <span class="location-text">Kaohsiung</span>
                </button>
            </div>

            <button class="overlay-btn" id="multiSelectBtn" onclick="toggleMultiSelect()">
                <svg style="margin-right:4px;" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-2h-2v-2h2v-2h2v2h2v2zm-4-6V7H5v10h12v-2h2v4H3V5h16v6h-2z"></path></svg>
                SELECT MULTIPLE
            </button>
        </div>
    </div>

    <div class="gallery-scroll">
        <div class="gallery-grid" id="galleryGrid">
            </div>
    </div>

    <input type="file" id="hiddenFileInput" accept="image/*" multiple>

    <script>
        // --- 1. IndexedDB 設定 ---
        const dbName = "MemoriesDB";
        const storeName = "photos";
        const channel = new BroadcastChannel('memory_update'); 
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        function getAllMemories() {
            return new Promise((resolve) => {
                if (!db) return resolve({});
                const tx = db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get("all_photos");
                req.onsuccess = (e) => resolve(e.target.result || {});
                req.onerror = () => resolve({});
            });
        }

        function saveAllMemories(data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const store = tx.objectStore(storeName);
                const req = store.put(data, "all_photos");
                req.onsuccess = () => resolve();
                req.onerror = () => reject();
            });
        }

        // --- 2. UI 互動邏輯 (Icon 反應) ---

        // 標記人名
        const btnTagPeople = document.getElementById('btnTagPeople');
        btnTagPeople.addEventListener('click', function() {
            this.classList.toggle('active');
        });

        // 標記地點 (仿真載入)
        const btnLocation = document.getElementById('btnLocation');
        btnLocation.addEventListener('click', function() {
            if (this.classList.contains('active')) {
                this.classList.remove('active');
            } else {
                this.classList.add('loading'); 
                setTimeout(() => {
                    this.classList.remove('loading'); 
                    this.classList.add('active'); 
                }, 1200);
            }
        });

        // --- 3. 相簿邏輯 ---
        
        let galleryImages = []; 
        let selectedIndices = new Set();
        let isMultiSelect = false;

        const mainPreview = document.getElementById('mainPreview');
        const galleryGrid = document.getElementById('galleryGrid');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const fileInput = document.getElementById('hiddenFileInput');
        const nextBtn = document.getElementById('nextBtn');

        // 初始化：渲染一次空的（只包含上傳按鈕）
        renderGalleryPhotos();

        // 檔案上傳
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;

            files.reverse().forEach(file => {
                galleryImages.unshift(URL.createObjectURL(file));
            });

            renderGalleryPhotos();
            
            // 預設選中最新的一張
            if (galleryImages.length > 0 && !isMultiSelect) {
                selectedIndices.clear();
                mainPreview.src = galleryImages[0];
                mainPreview.style.display = 'block';
            }
        });

        // 渲染相簿 (修改重點：第一格永遠是上傳按鈕)
        function renderGalleryPhotos() {
            galleryGrid.innerHTML = "";

            // 1. 建立第一個「上傳方塊」
            const uploadTile = document.createElement('div');
            uploadTile.className = 'gallery-item upload-tile';
            uploadTile.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"></path></svg><span>Gallery</span>`;
            uploadTile.onclick = () => document.getElementById('hiddenFileInput').click();
            galleryGrid.appendChild(uploadTile);

            // 2. 建立照片方塊
            const selectedArray = Array.from(selectedIndices);

            galleryImages.forEach((url, index) => {
                const item = document.createElement('div');
                const isSelected = selectedIndices.has(index);
                item.className = `gallery-item ${isSelected ? 'selected' : ''}`;
                
                const img = document.createElement('img');
                img.src = url;
                
                const badge = document.createElement('div');
                badge.className = 'selection-badge';
                
                if (isMultiSelect && isSelected) {
                    badge.textContent = selectedArray.indexOf(index) + 1;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                item.onclick = () => handleItemClick(index);
                item.appendChild(img);
                item.appendChild(badge);
                galleryGrid.appendChild(item);
            });
        }

        function toggleMultiSelect() {
            isMultiSelect = !isMultiSelect;
            
            if (isMultiSelect) {
                multiSelectBtn.classList.add('active');
                if (selectedIndices.size === 0 && galleryImages.length > 0 && mainPreview.src) {
                    const currentSrc = mainPreview.src;
                    const idx = galleryImages.indexOf(currentSrc);
                    if(idx !== -1) selectedIndices.add(idx);
                }
            } else {
                multiSelectBtn.classList.remove('active');
                selectedIndices.clear();
            }
            renderGalleryPhotos();
        }

        function handleItemClick(index) {
            const url = galleryImages[index];

            if (isMultiSelect) {
                if (selectedIndices.has(index)) {
                    selectedIndices.delete(index);
                } else {
                    selectedIndices.add(index);
                    mainPreview.src = url;
                    mainPreview.style.display = 'block';
                }
            } else {
                mainPreview.src = url;
                mainPreview.style.display = 'block';
                selectedIndices.clear(); 
            }
            renderGalleryPhotos();
        }

        // --- 4. Share 存檔邏輯 (不跳選項) ---
        nextBtn.addEventListener('click', async () => {
            let imagesToSave = [];

            if (selectedIndices.size > 0) {
                selectedIndices.forEach(idx => imagesToSave.push(galleryImages[idx]));
            } else if (mainPreview.src && mainPreview.style.display !== 'none') {
                imagesToSave.push(mainPreview.src);
            }

            if(imagesToSave.length === 0) {
                alert("Please select a photo first!");
                return;
            }

            nextBtn.textContent = "Posting...";
            nextBtn.style.opacity = "0.5";

            if (!db) await initDB();
            let memories = await getAllMemories();

            const now = new Date();
            const dateKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;

            if (!memories[dateKey]) memories[dateKey] = [];
            if (!Array.isArray(memories[dateKey])) memories[dateKey] = [memories[dateKey]];

            for (let url of imagesToSave) {
                try {
                    const base64 = await urlToBase64(url);
                    memories[dateKey].push(base64);
                } catch (e) { console.error(e); }
            }

            try {
                await saveAllMemories(memories);
                channel.postMessage('updated');
                window.location.href = "home.html"; 
            } catch (err) {
                alert("Storage full.");
                nextBtn.textContent = "Share";
                nextBtn.style.opacity = "1";
            }
        });

        function urlToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1024;
                    if(w > max) { h*=max/w; w=max; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = reject;
                img.src = url;
            });
        }

        initDB();
    </script>
</body>
</html>
