<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #F3ECE5;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        .header {
            flex-shrink: 0; height: 50px; padding: 0 16px; margin-top: 40px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: #F3ECE5; 
            z-index: 10;
        }

        .header-btn { font-size: 16px; font-weight: 600; text-decoration: none; cursor: pointer; border: none; background: none; }
        .cancel-btn { color: #6D5D55; }
        .title { font-size: 18px; font-weight: 700; color: #6D5D50; }
        .next-btn { color: #9C7C66; font-weight: 700; }
        .next-btn:disabled { color: #D6CCC2; }

        /* --- é è¦½å€åŸŸ --- */
        .preview-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #E3D5CA;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        #mainPreview {
            width: 100%; height: 100%; object-fit: cover;
            transition: opacity 0.2s;
            display: none; 
        }

        /* --- æµ®å‹•åŠŸèƒ½åˆ— --- */
        .overlay-bar {
            position: absolute; bottom: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 5;
            pointer-events: none; 
        }
        .overlay-bar > * { pointer-events: auto; } 

        .left-actions { display: flex; gap: 8px; align-items: center; }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .overlay-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 20px;
            height: 32px;
            padding: 0 8px; /* åŸºç¤ padding */
            border: none;
            display: flex; align-items: center; justify-content: center; /* é è¨­ç½®ä¸­ */
            gap: 6px;
            font-size: 12px; font-weight: 600;
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* å¹³æ»‘å½ˆæ€§å‹•ç•« */
            overflow: hidden;
            white-space: nowrap;
        }
        
        .circle-icon-btn {
            width: 32px; padding: 0; border-radius: 50%;
        }

  /* --- ä¿®æ­£å¾Œçš„ï¼šåœ°é»æŒ‰éˆ•æ¨£å¼ --- */
        #btnLocation {
            /* 1. å¼·åˆ¶è¨­å®šç‚ºæ­£åœ“å½¢ */
            width: 32px;       
            height: 32px;
            padding: 0;        /* é—œéµï¼šé è¨­æ²’æœ‰å…§è·ï¼Œä¸ç„¶æœƒè®Šæ©¢åœ“ */
            border-radius: 50%;
            
            /* 2. è®“ Icon çµ•å°ç½®ä¸­ */
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* 3. éæ¸¡å‹•ç•«è¨­å®š */
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* å•Ÿç”¨ç‹€æ…‹ï¼šè®Šæˆè† å›Šä¸¦å±•é–‹ */
        #btnLocation.active {
            width: auto;       /* å¯¬åº¦è‡ªå‹•é©æ‡‰æ–‡å­— */
            padding: 0 12px;   /* å±•é–‹å¾Œæ‰è£œå›å…§è· */
            border-radius: 20px;
            background: #9C7C66; 
            justify-content: flex-start; /* å…§å®¹é å·¦ */
        }

        .location-text {
            opacity: 0; 
            display: none;     /* é è¨­å®Œå…¨éš±è—ï¼Œä¸ä½”ç©ºé–“ */
            transform: translateX(10px);
            margin-left: 0;    /* é è¨­æ²’æœ‰é–“è· */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* ç•¶æŒ‰éˆ•è®Š active æ™‚ï¼Œé¡¯ç¤ºæ–‡å­— */
        #btnLocation.active .location-text {
            display: inline-block;
            opacity: 1;
            transform: translateX(0);
            margin-left: 6px;  /* å±•é–‹å¾Œæ‰çµ¦æ–‡å­—å·¦é‚Šä¸€é»ç©ºéš™ */
        }
        /* ä¸€èˆ¬æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹ */
        .overlay-btn.active:not(#btnLocation) {
            background: #9C7C66; 
            color: white;
        }
        
        .overlay-btn svg { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }

        /* è¼‰å…¥å‹•ç•« (é–ƒçˆ) */
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .overlay-btn.loading { animation: pulse 1s infinite ease-in-out; }


        /* --- ä¸‹æ–¹ç›¸ç°¿ç¶²æ ¼ --- */
        .gallery-scroll {
            flex: 1; overflow-y: auto; background: #F3ECE5;
        }

        /* 3æ¬„ç¶²æ ¼ */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 2px;
            padding: 2px;
        }

        .gallery-item {
            aspect-ratio: 1 / 1;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-color: #E3D5CA;
        }

        .gallery-item img {
            width: 100%; height: 100%; object-fit: cover;
            display: block; transition: opacity 0.2s;
        }

        /* ä¸Šå‚³æŒ‰éˆ•æ–¹å¡Š */
        .upload-tile {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #EBE1D7; 
            color: #9C7C66;
            font-size: 13px; font-weight: 700; gap: 5px;
            text-align: center;
            cursor: pointer;
        }
        .upload-tile svg { width: 28px; height: 28px; stroke-width: 2; }
        .upload-tile:active { background-color: #dccbc0; }

        /* é¸å–æ¨£å¼ */
        .gallery-item.selected img { opacity: 0.5; }
        
        .selection-badge {
            position: absolute; top: 6px; right: 6px; width: 22px; height: 22px;
            border-radius: 50%; border: 2px solid #F3ECE5;
            background: rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 700; color: white; z-index: 2;
            transition: transform 0.1s;
        }

        .gallery-item.selected .selection-badge {
            background: #9C7C66; border-color: #F3ECE5; transform: scale(1.1);
        }
        
        #hiddenFileInput { display: none; }
        
    </style>
</head>
<body>

    <div class="header">
        <a href="home.html" class="header-btn cancel-btn">Cancel</a>
        <div class="title">New Post</div>
        <button class="header-btn next-btn" id="nextBtn">Share</button>
    </div>

    <div class="preview-container">
        <img id="mainPreview" src="" alt="">

        <div class="overlay-bar">
            <div class="left-actions">
                <button id="btnTagPeople" class="overlay-btn circle-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </button>
                <button id="btnLocation" class="overlay-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                    <span class="location-text">Kaohsiung</span>
                </button>
            </div>

            <button class="overlay-btn" id="multiSelectBtn" onclick="toggleMultiSelect()">
                <svg style="margin-right:4px;" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-2h-2v-2h2v-2h2v2h2v2zm-4-6V7H5v10h12v-2h2v4H3V5h16v6h-2z"></path></svg>
                SELECT MULTIPLE
            </button>
        </div>
    </div>

    <div class="gallery-scroll">
        <div class="gallery-grid" id="galleryGrid">
            <div class="gallery-item upload-tile" onclick="document.getElementById('hiddenFileInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"></path></svg>
                <span>Gallery</span>
            </div>
        </div>
    </div>

    <input type="file" id="hiddenFileInput" accept="image/*" multiple>

    <script>
        // --- IndexedDB åˆå§‹åŒ– ---
        const dbName = "MemoriesDB";
        const storeName = "posts_timeline"; // æ”¹åï¼šä¸å†å­˜ photosï¼Œæ”¹å­˜ timeline
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 2); // â˜…â˜…â˜… ç‰ˆæœ¬è™Ÿå‡ç´šç‚º 2ï¼Œè§¸ç™¼æ›´æ–° â˜…â˜…â˜…
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    // å»ºç«‹æ–°çš„å„²å­˜å€ä¾†æ”¾è²¼æ–‡åˆ—è¡¨
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        // å–å¾—æ‰€æœ‰è²¼æ–‡åˆ—è¡¨ (é€™æœƒæ˜¯ä¸€å€‹ Array)
        function getTimeline() {
            return new Promise((resolve) => {
                if (!db) return resolve([]);
                const tx = db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get("feed_data");
                req.onsuccess = (e) => resolve(e.target.result || []); // é è¨­å›å‚³ç©ºé™£åˆ—
                req.onerror = () => resolve([]);
            });
        }

        // å„²å­˜æ•´å€‹åˆ—è¡¨
        function saveTimeline(data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const store = tx.objectStore(storeName);
                const req = store.put(data, "feed_data");
                req.onsuccess = () => resolve();
                req.onerror = () => reject();
            });
        }

        // --- è®Šæ•¸èˆ‡ UI é‚è¼¯ (ä¿æŒä¸è®Š) ---
        const imageLoader = document.getElementById('imageLoader');
        const placeholder = document.getElementById('placeholder');
        const previewSlider = document.getElementById('previewSlider');
        const reselectBtn = document.getElementById('reselectBtn');
        const shareBtn = document.getElementById('shareBtn');
        const pageIndicator = document.getElementById('pageIndicator');
        const compressCanvas = document.getElementById('compressCanvas');
        const ctx = compressCanvas.getContext('2d');
        let pendingImages = []; 

        // åœ–ç‰‡é¸æ“‡é‚è¼¯ (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        imageLoader.addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            placeholder.innerHTML = `<div style="opacity:0.6">Processing ${files.length} photos...</div>`;
            pendingImages = [];
            previewSlider.innerHTML = ''; 
            for (const file of files) {
                try {
                    const base64 = await processImage(file);
                    pendingImages.push(base64);
                } catch (err) { console.error(err); }
            }
            if (pendingImages.length > 0) {
                renderPreview();
                placeholder.style.display = 'none';
                previewSlider.style.display = 'flex';
                reselectBtn.style.display = 'flex';
                shareBtn.disabled = false;
                if(pendingImages.length > 1) {
                    pageIndicator.style.display = 'block';
                    pageIndicator.textContent = `1/${pendingImages.length}`;
                }
            } else { resetSelection(); }
        });

        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        let maxWidth = 1080;
                        let w = img.width; let h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        compressCanvas.width = w; compressCanvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(compressCanvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPreview() {
            previewSlider.innerHTML = pendingImages.map(src => `<div class="preview-item"><img src="${src}"></div>`).join('');
        }
        
        previewSlider.addEventListener('scroll', () => {
            const index = Math.round(previewSlider.scrollLeft / previewSlider.offsetWidth);
            pageIndicator.textContent = `${index + 1}/${pendingImages.length}`;
        });

        function resetSelection() {
            pendingImages = [];
            imageLoader.value = ""; 
            previewSlider.style.display = 'none'; previewSlider.innerHTML = '';
            reselectBtn.style.display = 'none'; pageIndicator.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.innerHTML = `<div class="upload-icon">ğŸ“·</div><p>Select photos</p><label class="upload-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg> Open Gallery<input type="file" id="imageLoader" accept="image/*" multiple style="display: none;"></label>`;
            shareBtn.disabled = true;
        }

        // --- â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šå„²å­˜é‚è¼¯ â˜…â˜…â˜… ---
        shareBtn.addEventListener('click', async () => {
            if (pendingImages.length === 0) return;
            shareBtn.textContent = "Posting...";
            shareBtn.disabled = true;

            if (!db) await initDB();
            
            // 1. è®€å–ç›®å‰çš„è²¼æ–‡åˆ—è¡¨ (Array)
            let timeline = await getTimeline();

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            
            // 2. å»ºç«‹ä¸€å€‹å…¨æ–°çš„è²¼æ–‡ç‰©ä»¶
            const newPost = {
                id: Date.now(), // ä½¿ç”¨æ™‚é–“æˆ³ç•¶ä½œå”¯ä¸€ ID
                timestamp: now.getTime(),
                dateString: dateStr,
                images: pendingImages, // é€™æ¬¡é¸çš„é€™çµ„ç…§ç‰‡
                likes: 0,
                isLiked: false,
                comments: [] // åˆå§‹ç‚ºç©ºï¼Œæˆ‘å€‘åœ¨ social.html æœƒè‡ªå‹•è£œä¸Šä½œè€…å…§æ–‡
            };

            // 3. åŠ åˆ°åˆ—è¡¨æœ€å‰é¢ (Unshift)
            timeline.unshift(newPost);

            try {
                // 4. å­˜å›è³‡æ–™åº«
                await saveTimeline(timeline);
                window.location.href = "social.html";
            } catch (err) {
                console.error(err);
                alert("Upload failed.");
                shareBtn.textContent = "Share";
                shareBtn.disabled = false;
            }
        });

        initDB();
    </script>
</body>
</html>
       
