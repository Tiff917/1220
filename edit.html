<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <style>
        /* --- 全局設定 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #fff; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- 頂部導航 --- */
        .header {
            flex-shrink: 0; height: 50px; padding: 0 16px; margin-top: 40px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: #fff; 
            z-index: 100; border-bottom: 1px solid #eee;
        }

        .header-btn { font-size: 16px; font-weight: 600; text-decoration: none; cursor: pointer; border: none; background: none; }
        .cancel-btn { color: #000; }
        .title { font-size: 17px; font-weight: 700; color: #000; }
        .next-btn { color: #9C7C66; font-weight: 700; } /* 莫蘭迪棕色 */
        .next-btn:disabled { color: #e0d0c8; }

        /* --- 預覽區域 (1:1 正方形) --- */
        .preview-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #f8f8f8; /* 淺灰底色 */
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
        }

        #mainPreview {
            width: 100%; height: 100%; object-fit: cover;
            display: none; /* 有圖才顯示 */
        }

        /* 沒圖時的提示文字 */
        .empty-tip { color: #999; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px; }

        /* --- 浮動功能列 (Tag, Location, Multi) --- */
        .overlay-bar {
            position: absolute; bottom: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }

        .left-actions { display: flex; gap: 8px; }

        .overlay-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 20px;
            height: 32px;
            padding: 0 12px;
            border: none;
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; font-weight: 600;
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .circle-icon-btn { width: 32px; height: 32px; padding: 0; justify-content: center; border-radius: 50%; }

        /* 啟用狀態：變為莫蘭迪棕 */
        .overlay-btn.active {
            background: #9C7C66; 
            color: white;
        }
        
        .overlay-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* --- 下方相簿網格 --- */
        .gallery-scroll {
            flex: 1; overflow-y: auto; background: #fff;
        }

        /* 模擬相簿選取按鈕 */
        .open-gallery-trigger {
            padding: 15px; text-align: center; color: #666; font-weight: 500; font-size: 14px;
            border-bottom: 1px solid #eee; cursor: pointer; background: #fafafa;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4欄 */
            gap: 2px;
            padding: 2px 0;
        }

        .gallery-item {
            aspect-ratio: 1 / 1;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background: #eee;
        }

        .gallery-item img {
            width: 100%; height: 100%; object-fit: cover;
            display: block;
            transition: opacity 0.2s;
        }

        /* 選取遮罩 */
        .gallery-item.selected img { opacity: 0.5; }
        
        /* 編號圈圈 */
        .selection-badge {
            position: absolute; top: 6px; right: 6px;
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 700; color: white;
            z-index: 5;
        }

        .gallery-item.selected .selection-badge {
            background: #9C7C66; /* 這裡改為你的主題色 */
            border-color: #9C7C66;
        }
        
        #hiddenFileInput { display: none; }
        
    </style>
</head>
<body>

    <div class="header">
        <a href="home.html" class="header-btn cancel-btn">Back</a>
        <div class="title">New Post (IG Style)</div>
        <button class="header-btn next-btn" id="nextBtn">Share</button>
    </div>

    <div class="preview-container">
        <div class="empty-tip" id="emptyTip">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            <span>Select a photo below</span>
        </div>

        <img id="mainPreview" src="" alt="">

        <div class="overlay-bar">
            <div class="left-actions">
                <button class="overlay-btn circle-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </button>
                <button class="overlay-btn circle-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                </button>
            </div>

            <button class="overlay-btn" id="multiSelectBtn" onclick="toggleMultiSelect()">
                <svg style="margin-right:4px;" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-2h-2v-2h2v-2h2v2h2v2zm-4-6V7H5v10h12v-2h2v4H3V5h16v6h-2z"></path></svg>
                SELECT MULTIPLE
            </button>
        </div>
    </div>

    <div class="gallery-scroll">
        <div class="open-gallery-trigger" onclick="document.getElementById('hiddenFileInput').click()">
            + Open Phone Gallery / Camera Roll
        </div>

        <div class="gallery-grid" id="galleryGrid"></div>
    </div>

    <input type="file" id="hiddenFileInput" accept="image/*" multiple>

    <script>
        // --- 1. IndexedDB 設定 ---
        const dbName = "MemoriesDB";
        const storeName = "photos";
        const channel = new BroadcastChannel('memory_update'); 
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        function getAllMemories() {
            return new Promise((resolve) => {
                if (!db) return resolve({});
                const tx = db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get("all_photos");
                req.onsuccess = (e) => resolve(e.target.result || {});
                req.onerror = () => resolve({});
            });
        }

        function saveAllMemories(data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const store = tx.objectStore(storeName);
                const req = store.put(data, "all_photos");
                req.onsuccess = () => resolve();
                req.onerror = () => reject();
            });
        }

        // --- 2. 相簿邏輯 ---
        
        // 預設假照片 (讓你不用一直選也能測試 UI)
        let galleryImages = [
            "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400",
            "https://images.unsplash.com/photo-1495147466023-ac5c588e2e94?w=400",
            "https://images.unsplash.com/photo-1516975080664-ed2fc6a32937?w=400",
            "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400",
            "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400"
        ];

        let selectedIndices = new Set();
        let isMultiSelect = false;

        const mainPreview = document.getElementById('mainPreview');
        const emptyTip = document.getElementById('emptyTip');
        const galleryGrid = document.getElementById('galleryGrid');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const fileInput = document.getElementById('hiddenFileInput');
        const nextBtn = document.getElementById('nextBtn');

        // 初始化
        // 預設選第一張
        mainPreview.src = galleryImages[0];
        mainPreview.style.display = 'block';
        emptyTip.style.display = 'none';
        renderGallery();

        // 監聽檔案上傳
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;

            files.reverse().forEach(file => {
                const blobUrl = URL.createObjectURL(file);
                galleryImages.unshift(blobUrl);
            });

            renderGallery();
            // 自動選取最新那張
            if (!isMultiSelect) {
                selectedIndices.clear();
                updateMainPreview(0);
            }
        });

        function renderGallery() {
            galleryGrid.innerHTML = "";
            const selectedArray = Array.from(selectedIndices);

            galleryImages.forEach((url, index) => {
                const item = document.createElement('div');
                const isSelected = selectedIndices.has(index);
                item.className = `gallery-item ${isSelected ? 'selected' : ''}`;
                
                const img = document.createElement('img');
                img.src = url;
                
                const badge = document.createElement('div');
                badge.className = 'selection-badge';
                
                if (isMultiSelect && isSelected) {
                    const order = selectedArray.indexOf(index) + 1;
                    badge.textContent = order;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                item.onclick = () => handleItemClick(index);
                item.appendChild(img);
                item.appendChild(badge);
                galleryGrid.appendChild(item);
            });
        }

        function toggleMultiSelect() {
            isMultiSelect = !isMultiSelect;
            
            if (isMultiSelect) {
                multiSelectBtn.classList.add('active');
                // 若當前沒選，預設選預覽那張
                if (selectedIndices.size === 0 && mainPreview.src) {
                    const currentSrc = mainPreview.src;
                    const idx = galleryImages.indexOf(currentSrc);
                    if(idx !== -1) selectedIndices.add(idx);
                }
            } else {
                multiSelectBtn.classList.remove('active');
                selectedIndices.clear();
            }
            renderGallery();
        }

        function handleItemClick(index) {
            const url = galleryImages[index];

            if (isMultiSelect) {
                if (selectedIndices.has(index)) {
                    selectedIndices.delete(index);
                } else {
                    selectedIndices.add(index);
                    updateMainPreview(index);
                }
            } else {
                updateMainPreview(index);
                selectedIndices.clear(); // 單選模式不顯示圈圈
            }
            renderGallery();
        }

        function updateMainPreview(index) {
            mainPreview.src = galleryImages[index];
            mainPreview.style.display = 'block';
            emptyTip.style.display = 'none';
        }

        // --- 3. Share 存檔 ---
        nextBtn.addEventListener('click', async () => {
            let imagesToSave = [];

            if (selectedIndices.size > 0) {
                selectedIndices.forEach(idx => imagesToSave.push(galleryImages[idx]));
            } else if (mainPreview.src && mainPreview.style.display !== 'none') {
                imagesToSave.push(mainPreview.src);
            }

            if(imagesToSave.length === 0) {
                alert("Please select a photo first!");
                return;
            }

            nextBtn.textContent = "Posting...";
            nextBtn.style.opacity = "0.5";

            if (!db) await initDB();
            let memories = await getAllMemories();

            const now = new Date();
            const dateKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;

            if (!memories[dateKey]) memories[dateKey] = [];
            if (!Array.isArray(memories[dateKey])) memories[dateKey] = [memories[dateKey]];

            // 批次轉換
            for (let url of imagesToSave) {
                try {
                    const base64 = await urlToBase64(url);
                    memories[dateKey].push(base64);
                } catch (e) {
                    console.error("Image error:", e);
                }
            }

            try {
                await saveAllMemories(memories);
                channel.postMessage('updated');
                window.location.href = "home.html"; // 跳轉回首頁
            } catch (err) {
                alert("Storage full.");
                nextBtn.textContent = "Share";
                nextBtn.style.opacity = "1";
            }
        });

        function urlToBase64(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 1024;
                    if(w > max) { h*=max/w; w=max; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = reject;
                img.src = url;
            });
        }

        initDB();
    </script>
</body>
</html>
