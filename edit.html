<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>New Post</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- 1. åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #ffffff; color: #000; padding-bottom: 20px; }
        
        /* --- 2. é ‚éƒ¨å°èˆª --- */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; background: #fff; position: sticky; top: 0; z-index: 50;
        }
        .header-btn { font-size: 16px; color: #8e8e93; border: none; background: none; cursor: pointer; }
        .header-title { font-size: 17px; font-weight: 600; }
        .header-btn.finish { color: #be9f82; font-weight: 600; } 

        /* --- 3. ä¸»åœ–é è¦½å€ --- */
        .main-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1; /* æ­£æ–¹å½¢ */
            background-color: #f0f0f0;
            overflow: hidden;
        }
        
        #mainPreviewImg {
            width: 100%; height: 100%; object-fit: cover;
            transition: opacity 0.3s;
        }

        /* é¡¯ç¤ºåœ°é»æ¨™ç±¤ (æ¨¡æ“¬æŠ“åˆ°é«˜é›„å¾Œé¡¯ç¤º) */
        .location-tag {
            position: absolute;
            bottom: 60px; /* åœ¨æŒ‰éˆ•ä¸Šæ–¹ */
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: none; /* é è¨­éš±è— */
            backdrop-filter: blur(4px);
        }

        /* æµ®å‹•æ§åˆ¶åˆ— */
        .overlay-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            left: 15px;
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            gap: 10px;
            pointer-events: none; 
        }

        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
        .control-btn {
            height: 36px;
            border: none;
            color: white;
            background: rgba(0, 0, 0, 0.4); /* é è¨­ï¼šåŠé€æ˜æ·ºé»‘ */
            backdrop-filter: blur(4px);
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }

        /* åœ“å½¢æŒ‰éˆ• (æœ‹å‹/åœ°é») */
        .btn-circle {
            width: 36px;
            border-radius: 50%;
        }

        /* è† å›ŠæŒ‰éˆ• (å¤šé¸) */
        .btn-capsule {
            padding: 0 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            gap: 6px;
        }

        /* â˜…â˜…â˜… æŒ‰éˆ•è¢«é»æ“Š/é¸å–å¾Œçš„æ¨£å¼ (è®Šæ·±è‰²) â˜…â˜…â˜… */
        .control-btn.active {
            background: rgba(0, 0, 0, 0.85); /* è®Šæˆæ·±é»‘è‰² */
            transform: scale(1.05); /* å¾®å¾®æ”¾å¤§å›é¥‹ */
        }

        /* --- 4.ä¸‹æ–¹ç…§ç‰‡ç¶²æ ¼ (æ”¹ç‚ºä¸€è¡Œä¸‰å¼µ) --- */
        .grid-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* â˜…â˜…â˜… ä¸€è¡Œ 3 å¼µ â˜…â˜…â˜… */
            gap: 2px;
            margin-top: 2px;
        }
        .grid-item {
            position: relative;
            aspect-ratio: 1/1;
            overflow: hidden;
            background: #eee;
            cursor: pointer;
        }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: opacity 0.2s; }
        
        /* é¸ä¸­ç‹€æ…‹ / ç•¶å‰ä¸»åœ–ç‹€æ…‹ */
        .grid-item.active img { opacity: 1; }
        
        /* å¤šé¸æ¨¡å¼ä¸‹çš„é®ç½© */
        .grid-item.selected .overlay-mask { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.3); 
        }
        
        /* å‹¾é¸åœˆåœˆ */
        .check-circle {
            position: absolute; top: 6px; right: 6px;
            width: 20px; height: 20px;
            border-radius: 50%; border: 2px solid white;
            background: rgba(0,0,0,0.2);
            display: none; /* é¸å–æ¨¡å¼æ‰é¡¯ç¤º */
            z-index: 10;
        }
        .grid-item.selected .check-circle { 
            background: #be9f82; border-color: #be9f82; 
        }

        /* éš±è— Canvas */
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <button class="header-btn" onclick="history.back()">Back</button>
        <div class="header-title">Post</div>
        <button class="header-btn finish" id="shareBtn">Finish</button>
    </div>

    <div id="contentArea">
        
        <div class="main-preview-container">
            <img id="mainPreviewImg" src="" alt="Preview">
            
            <div id="locationTag" class="location-tag">ğŸ“ Kaohsiung</div>

            <div class="overlay-controls">
                <button class="control-btn btn-circle" id="tagFriendBtn">
                    <i data-lucide="user" size="18"></i>
                </button>
                <button class="control-btn btn-circle" id="locationBtn">
                    <i data-lucide="map-pin" size="18"></i>
                </button>
                <button class="control-btn btn-capsule" id="multiSelectBtn">
                    <i data-lucide="layers" size="16"></i>
                    SELECT MULTIPLE
                </button>
            </div>
        </div>

        <div class="grid-gallery" id="gridGallery"></div>
        
        <input type="file" id="imageLoader" accept="image/*" multiple style="display: none;">
    </div>

    <canvas id="compressCanvas"></canvas>

    <script>
        // åˆå§‹åŒ– Icons
        lucide.createIcons();

        // --- Database Setup ---
        const dbName = "MemoriesDB";
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 2);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains("posts_timeline")) {
                        db.createObjectStore("posts_timeline", { keyPath: "id" });
                    }
                    if (!db.objectStoreNames.contains("all_photos")) {
                        db.createObjectStore("all_photos", { autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        // --- DOM Elements ---
        const mainPreviewImg = document.getElementById('mainPreviewImg');
        const gridGallery = document.getElementById('gridGallery');
        const multiSelectBtn = document.getElementById('multiSelectBtn');
        const tagFriendBtn = document.getElementById('tagFriendBtn');
        const locationBtn = document.getElementById('locationBtn');
        const locationTag = document.getElementById('locationTag');
        const shareBtn = document.getElementById('shareBtn');
        const compressCanvas = document.getElementById('compressCanvas');
        const ctx = compressCanvas.getContext('2d');

        // --- State ---
        // ç‚ºäº†è®“ç•«é¢ä¸€é–‹å§‹å°±æ˜¯å®Œæ•´çš„ï¼Œæˆ‘å€‘å…ˆé è¼‰ä¸€äº›ç¯„ä¾‹åœ–ç‰‡
        // å¯¦ä½œæ™‚æ‚¨å¯ä»¥æ›æˆçœŸå¯¦é‚è¼¯ï¼Œæˆ–ä¿ç•™é€™äº›ç•¶ä½œé è¨­å€¼
        let pendingImages = [
            "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=800&q=80", // ç›¸æ©Ÿ
            "https://images.unsplash.com/photo-1551334787-21e6bd3ab135?w=800&q=80", // é‹å­
            "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800&q=80", // æ‰‹éŒ¶
            "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800&q=80", // è€³æ©Ÿ
            "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800&q=80", // ç´…é‹
            "https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=800&q=80"  // å¢¨é¡
        ];
        
        let selectedIndices = []; // å·²é¸å–çš„ç´¢å¼•
        let isSelectMode = false;
        let isFriendTagged = false; // æ˜¯å¦æœ‰é»æ“Šéæ¨™è¨»æœ‹å‹
        let currentLocation = null; // åœ°é»
        let currentMainIndex = 0;   // ç•¶å‰å¤§åœ–ç´¢å¼•

        // --- Logic: åˆå§‹åŒ– ---
        window.onload = () => {
            // ä¸€é€²å…¥é é¢ç›´æ¥æ¸²æŸ“ï¼Œä¸é¡¯ç¤º Open Gallery
            if (pendingImages.length > 0) {
                // é è¨­é¸å–å…¨éƒ¨
                selectedIndices = pendingImages.map((_, i) => i);
                renderMainPreview();
                renderGrid();
            }
        };

        // --- Logic: æ¸²æŸ“ ---
        function renderMainPreview() {
            if (pendingImages[currentMainIndex]) {
                // æ·¡å…¥æ•ˆæœ
                mainPreviewImg.style.opacity = 0;
                setTimeout(() => {
                    mainPreviewImg.src = pendingImages[currentMainIndex];
                    mainPreviewImg.style.opacity = 1;
                }, 50);
            }
        }

        function renderGrid() {
            gridGallery.innerHTML = pendingImages.map((src, idx) => {
                const isSelected = selectedIndices.includes(idx);
                const isActive = (idx === currentMainIndex); // æ˜¯å¦æ­£åœ¨ä¸»åœ–é¡¯ç¤º
                
                // åªæœ‰åœ¨é¸å–æ¨¡å¼æ‰é¡¯ç¤ºå‹¾å‹¾
                const checkCircle = isSelectMode 
                    ? `<div class="check-circle" style="display:block;"></div>` 
                    : '';
                
                const mask = isSelectMode && isSelected 
                    ? `<div class="overlay-mask"></div>` 
                    : '';

                return `
                    <div class="grid-item ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="handleGridClick(${idx})">
                        <img src="${src}">
                        ${mask}
                        ${checkCircle}
                    </div>
                `;
            }).join('');
        }

        // --- Logic: äº’å‹• ---
        
        // 1. ç¶²æ ¼é»æ“Š
        window.handleGridClick = (idx) => {
            if (isSelectMode) {
                // å¤šé¸æ¨¡å¼ï¼šåˆ‡æ›é¸å–ç‹€æ…‹
                if (selectedIndices.includes(idx)) {
                    selectedIndices = selectedIndices.filter(i => i !== idx);
                } else {
                    selectedIndices.push(idx);
                }
                renderGrid();
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šåˆ‡æ›ä¸Šæ–¹å¤§åœ–
                currentMainIndex = idx;
                renderMainPreview();
                renderGrid();
            }
        };

        // 2. æ¨™è¨»æœ‹å‹ (ç´”æŒ‰éˆ•è®Šè‰²ï¼Œä¸é¡¯ç¤ºåˆ—è¡¨)
        tagFriendBtn.addEventListener('click', () => {
            isFriendTagged = !isFriendTagged;
            // åˆ‡æ› active class è®“æŒ‰éˆ•è®Šæ·±è‰²
            tagFriendBtn.classList.toggle('active', isFriendTagged);
        });

        // 3. æ¨™è¨»åœ°é» (æ¨¡æ“¬æŠ“å– -> é«˜é›„ -> è®Šæ·±è‰²)
        locationBtn.addEventListener('click', () => {
            if (currentLocation) {
                // å¦‚æœå·²ç¶“æœ‰åœ°é»ï¼Œå†æ¬¡é»æ“Šå‰‡æ˜¯å–æ¶ˆ
                currentLocation = null;
                locationBtn.classList.remove('active');
                locationTag.style.display = 'none';
            } else {
                // æ¨¡æ“¬æŠ“å– loading æ„Ÿè¦º (é€™è£¡å¯ä»¥åŠ å€‹è½‰åœˆåœˆï¼Œä½†ç°¡å–®èµ·è¦‹ç”¨è®Šè‰²é‚è¼¯)
                locationBtn.style.opacity = "0.5"; 
                
                setTimeout(() => {
                    // 0.5ç§’å¾ŒæŠ“åˆ°åœ°é»
                    currentLocation = "Kaohsiung";
                    locationBtn.style.opacity = "1";
                    locationBtn.classList.add('active'); // è®Šæ·±è‰²
                    locationTag.style.display = 'block'; // é¡¯ç¤ºåœ–ç‰‡ä¸Šçš„æ¨™ç±¤
                }, 500);
            }
        });

        // 4. åˆ‡æ›å¤šé¸æ¨¡å¼ (è®Šæ·±è‰²)
        multiSelectBtn.addEventListener('click', () => {
            isSelectMode = !isSelectMode;
            multiSelectBtn.classList.toggle('active', isSelectMode);
            renderGrid(); // é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤º/éš±è—å‹¾å‹¾
        });

        // --- Logic: å„²å­˜èˆ‡ç™¼å¸ƒ ---
        shareBtn.addEventListener('click', async () => {
            // éæ¿¾è¦ç™¼å¸ƒçš„ç…§ç‰‡
            const imagesToPost = pendingImages.filter((_, i) => selectedIndices.includes(i));
            if (imagesToPost.length === 0) {
                alert("Please select at least one photo.");
                return;
            }

            shareBtn.textContent = "Posting...";
            
            if (!db) await initDB();

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            
            // æº–å‚™ Post è³‡æ–™ (Socialç”¨)
            const newPost = {
                id: Date.now(),
                timestamp: now.getTime(),
                dateString: dateStr,
                images: imagesToPost, 
                location: currentLocation, // é€™è£¡æœƒæ˜¯ "Kaohsiung" æˆ– null
                isFriendTagged: isFriendTagged, // åªå­˜æ˜¯å¦æ¨™è¨»çš„ç‹€æ…‹
                likes: 0,
                comments: []
            };

            // æº–å‚™ Memories è³‡æ–™ (Memoriesç”¨)
            const memoryItems = imagesToPost.map(imgUrl => ({
                date: dateStr,
                timestamp: now.getTime(),
                image: imgUrl
            }));

            // é–‹å§‹äº¤æ˜“
            const tx = db.transaction(["posts_timeline", "all_photos"], "readwrite");
            
            tx.objectStore("posts_timeline").add(newPost);
            
            const memoriesStore = tx.objectStore("all_photos");
            memoryItems.forEach(item => memoriesStore.add(item));

            tx.oncomplete = () => {
                console.log("Success!");
                window.location.href = "home.html";
            };

            tx.onerror = (err) => {
                console.error("Failed", err);
                alert("Error saving post");
                shareBtn.textContent = "Finish";
            };
        });

        initDB();
    </script>
</body>
</html>
