<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Feed</title>
    <style>
        /* --- 1. Âü∫Á§éË®≠ÂÆö --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #262626; 
            overflow-x: hidden;
        }
        body::-webkit-scrollbar { display: none; }

        /* --- 2. ÂãïÊÖãÁâÜÂÆπÂô® --- */
        #feed-container { width: 100%; margin: 0; padding-bottom: 80px; padding-top: 10px; }

        /* Ë≤ºÊñáÂç°Áâá */
        .post-card { background: white; border-bottom: 1px solid #efefef; margin-bottom: 10px; padding-bottom: 10px; }

        /* Ë≤ºÊñáÈ†≠ÈÉ® */
        .post-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(0,0,0,0.1); }
        .username { font-weight: 600; font-size: 14px; text-decoration: none; color: #262626; }
        .location { font-size: 12px; color: #262626; display: block; }

        /* ÂúñÁâáËº™Êí≠ */
        .media-container { position: relative; width: 100%; aspect-ratio: 1 / 1; background: #fafafa; }
        .slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider::-webkit-scrollbar { display: none; }
        .slide-item { flex: 0 0 100%; width: 100%; height: 100%; scroll-snap-align: start; }
        .slide-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .image-counter {
            position: absolute; top: 14px; right: 14px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 4px 10px; border-radius: 14px;
            font-size: 12px; font-weight: 600;
            display: none; pointer-events: none;
        }

        /* ‰∫íÂãïÂçÄ */
        .action-bar { padding: 10px 14px; display: flex; align-items: center; position: relative; height: 44px; }
        .action-left { display: flex; gap: 16px; align-items: center; }
        .icon-btn { cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .pagination-dots { display: flex; gap: 4px; position: absolute; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #dbdbdb; transition: background 0.2s; }
        .dot.active { background: #bfa093; }

        /* ÊñáÂ≠óÂÖßÂÆπ */
        .post-content { padding: 0 14px; font-size: 14px; }
        .likes-count { font-weight: 600; margin-bottom: 8px; display: block; }
        .comments-preview { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .comment-row { line-height: 1.4; word-wrap: break-word; margin-bottom: 4px; }
        .comment-user { font-weight: 600; margin-right: 5px; }
        .timestamp { font-size: 10px; color: #8e8e8e; text-transform: uppercase; margin-bottom: 12px; display: block; }

        /* ÁïôË®ÄËº∏ÂÖ• */
        .add-comment-section { display: flex; align-items: center; padding-top: 10px; border-top: 1px solid #efefef; margin-top: 5px; }
        .user-avatar-small { width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .comment-input { flex: 1; border: none; font-size: 14px; padding: 5px 0; background: transparent; }
        .post-btn { color: #bfa093; font-weight: 600; font-size: 14px; border: none; background: none; cursor: pointer; padding-left: 10px; opacity: 0.5; pointer-events: none; }
        .post-btn.active { opacity: 1; pointer-events: auto; }

        /* Á©∫ÁãÄÊÖã */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: #8e8e8e; gap: 15px; }
        .empty-icon { font-size: 40px; opacity: 0.3; }
    </style>
</head>
<body>

    <div id="feed-container">
        <div class="empty-state" id="loading-msg">
            <div class="empty-icon">üì∑</div>
            <div>Loading feed...</div>
        </div>
    </div>

    <script>
        // --- 1. ‰ΩøÁî®ËÄÖË≥áË®äËàáË≥áÊñôÂ∫´ ---
        const dbName = "MemoriesDB";
        const channel = new BroadcastChannel('memory_update'); 
        let db;
        let postsData = [];
        let userAvatarUrl = "https://i.pravatar.cc/150?img=68"; // È†êË®≠È†≠ÂÉè
        let userName = localStorage.getItem('myProfileName') || "Me";

        // Áõ£ËÅΩÊõ¥Êñ∞ (‰æãÂ¶ÇÁôºÂÆåÊñáÂõû‰æÜÔºåËá™ÂãïÈáçÊï¥)
        channel.onmessage = (event) => {
            if (event.data === 'updated') loadAndRender();
        };

        function initDB() {
            return new Promise((resolve, reject) => {
                // ‚òÖ‚òÖ‚òÖ ÁâàÊú¨ 6ÔºåËàá Post/Home/Memories ‰∏ÄËá¥ ‚òÖ‚òÖ‚òÖ
                const request = indexedDB.open(dbName, 6);
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains("posts_timeline")) db.createObjectStore("posts_timeline", { keyPath: "id" });
                    if (!db.objectStoreNames.contains("user_profile")) db.createObjectStore("user_profile");
                };

                request.onsuccess = (e) => { 
                    db = e.target.result; 
                    resolve(db); 
                };
                request.onerror = (e) => reject(e);
            });
        }

        // --- 2. ËÆÄÂèñË≥áÊñô (Ë≤ºÊñá + È†≠ÂÉè) ---
        async function loadAndRender() {
            try {
                await initDB();
                
                // 1. ËÆÄÂèñÊàëÁöÑÈ†≠ÂÉè (Blob -> URL)
                const avatarTx = db.transaction("user_profile", "readonly");
                const avatarReq = avatarTx.objectStore("user_profile").get("avatar");
                
                avatarReq.onsuccess = (e) => {
                    const res = e.target.result;
                    if (res && (res instanceof Blob || res instanceof File)) {
                        userAvatarUrl = URL.createObjectURL(res);
                    }
                };

                // 2. ËÆÄÂèñË≤ºÊñáÊôÇÈñìËª∏
                const tx = db.transaction("posts_timeline", "readonly");
                const store = tx.objectStore("posts_timeline");
                const request = store.openCursor(null, 'prev'); // 'prev' = ÂæûÊñ∞Âà∞ËàäÊéíÂ∫è
                
                const tempPosts = [];
                
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        const post = cursor.value;
                        // ËôïÁêÜÂúñÁâá Blob -> URL
                        post.imageUrls = post.images.map(blob => 
                            (blob instanceof Blob || blob instanceof File) ? URL.createObjectURL(blob) : blob
                        );
                        tempPosts.push(post);
                        cursor.continue();
                    } else {
                        postsData = tempPosts;
                        renderPosts();
                    }
                };

            } catch (e) {
                console.error("Loading error:", e);
                document.getElementById('loading-msg').textContent = "Failed to load feed.";
            }
        }

        // --- 3. Ê∏≤ÊüìÁï´Èù¢ ---
        const feedContainer = document.getElementById('feed-container');
        
        const icons = {
            more: '<svg aria-label="More" color="#262626" fill="#262626" height="24" viewBox="0 0 24 24" width="24"><circle cx="12" cy="12" r="1.5"></circle><circle cx="6" cy="12" r="1.5"></circle><circle cx="18" cy="12" r="1.5"></circle></svg>',
            heartOutline: '<svg aria-label="Like" color="#262626" fill="#262626" height="24" viewBox="0 0 24 24" width="24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.956-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.622-3.067c.285-.253.571-.5.854-.747 2.465-2.143 5.015-4.36 5.015-7.97a6.985 6.985 0 0 0-6.792-6.218Z"></path></svg>',
            heartFilled: '<svg aria-label="Unlike" fill="#ed4956" height="24" viewBox="0 0 48 48" width="24"><path d="M34.6 3.1c-4.5 0-7.9 1.8-10.6 5.6-2.7-3.7-6.1-5.5-10.6-5.5C6 3.1 0 9.6 0 17.6c0 7.3 5.4 12 10.6 16.5.6.5 1.3 1.1 1.9 1.7l2.3 2c4.4 3.9 6.6 5.9 7.6 6.5.5.3 1.1.5 1.6.5s1.1-.2 1.6-.5c1-.6 2.8-2.2 7.8-6.8l2-1.8c.7-.6 1.3-1.2 2-1.7C42.7 29.6 48 25 48 17.6c0-8-6-14.5-13.4-14.5z"></path></svg>',
            comment: '<svg aria-label="Comment" fill="none" height="24" viewBox="0 0 24 24" width="24"><path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" stroke="black" stroke-linejoin="round" stroke-width="1.5"></path></svg>'
        };

        function renderPosts() {
            if (postsData.length === 0) {
                feedContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì∑</div>
                        <div>No posts yet.</div>
                    </div>`;
                return;
            }

            feedContainer.innerHTML = postsData.map(post => {
                const imagesHtml = post.imageUrls.map(url => `<div class="slide-item"><img src="${url}"></div>`).join('');
                const dotsHtml = post.imageUrls.length > 1 ? `<div class="pagination-dots" id="dots-${post.id}">${post.imageUrls.map((_, i) => `<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>` : '';
                const counterDisplay = post.imageUrls.length > 1 ? 'block' : 'none';
                
                // È†êË®≠Ë™™ÊòéÊñáÂ≠ó
                const captionText = (post.comments && post.comments.length > 0) ? post.comments[0].text : `Memory from ${post.dateString} ‚ú®`;
                const locationHtml = post.location ? `<span class="location">${post.location}</span>` : `<span class="location">${post.dateString}</span>`;

                return `
                <div class="post-card" id="post-${post.id}">
                    <div class="post-header">
                        <div class="user-info">
                            <img src="${userAvatarUrl}" class="avatar">
                            <div><span class="username">${userName}</span>${locationHtml}</div>
                        </div>
                        <div class="icon-btn">${icons.more}</div>
                    </div>
                    <div class="media-container">
                        <div class="image-counter" id="counter-${post.id}" style="display:${counterDisplay}">1/${post.imageUrls.length}</div>
                        <div class="slider" onscroll="updateSlider(${post.id})" id="slider-${post.id}">${imagesHtml}</div>
                    </div>
                    <div class="action-bar">
                        <div class="action-left">
                            <div class="icon-btn" onclick="toggleLike(this)">${icons.heartOutline}</div>
                            <div class="icon-btn">${icons.comment}</div>
                        </div>
                        ${dotsHtml}
                    </div>
                    <div class="post-content">
                        <span class="likes-count">${post.likes || 0} likes</span>
                        <div class="comment-row"><span class="comment-user">${userName}</span>${captionText}</div>
                        <div class="timestamp">${new Date(post.timestamp).toDateString()}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateSlider(postId) {
            const slider = document.getElementById(`slider-${postId}`);
            const dotsContainer = document.getElementById(`dots-${postId}`);
            const counter = document.getElementById(`counter-${postId}`);
            if (!dotsContainer) return;
            const index = Math.round(slider.scrollLeft / slider.offsetWidth);
            Array.from(dotsContainer.children).forEach((dot, i) => dot.classList.toggle('active', i === index));
            counter.innerText = `${index + 1}/${dotsContainer.children.length}`;
        }

        function toggleLike(btn) {
            const isFilled = btn.innerHTML.includes('fill="#ed4956"');
            btn.innerHTML = isFilled ? icons.heartOutline : icons.heartFilled;
        }

        // ÂïüÂãï
        loadAndRender();

    </script>
</body>
</html>
