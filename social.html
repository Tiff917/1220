<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Feed</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š (å®Œå…¨ä¿ç•™åŸæœ¬æ¨£å¼) --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #F3ECE5; /* ç±³è‰²èƒŒæ™¯ */
            color: #000;
            padding-bottom: 80px; /* é ç•™åº•éƒ¨ç©ºé–“ */
        }

        /* éš±è—æ²è»¸ä½†å…è¨±æ²å‹• */
        body::-webkit-scrollbar { display: none; }

        /* --- 2. è²¼æ–‡å¡ç‰‡ (Post) --- */
        .post {
            background-color: #F3ECE5; /* èˆ‡èƒŒæ™¯èåˆ */
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05); /* æ·¡æ·¡çš„åˆ†éš”ç·š */
        }

        /* --- Header: é ­åƒã€åå­—ã€åœ°é» --- */
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .user-text {
            display: flex;
            flex-direction: column;
        }

        .username-row {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .username {
            font-weight: 700;
            font-size: 14px;
            color: #000;
        }

        .bell-icon {
            color: #E03E3E; /* ç´…è‰²éˆ´éº */
        }

        .location {
            font-size: 11px;
            color: #555;
        }

        .more-btn {
            color: #000;
            cursor: pointer;
        }

        /* --- Image Slider: å¤šåœ–è¼ªæ’­ --- */
        .image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/5; /* IG å¸¸ç”¨çš„é•·æ–¹å½¢æ¯”ä¾‹ */
            overflow: hidden;
            background-color: #e0d5cc; /* åœ–ç‰‡è¼‰å…¥å‰çš„åº•è‰² */
        }

        .slider {
            display: flex;
            width: 100%;
            height: 100%;
            overflow-x: scroll;
            scroll-snap-type: x mandatory;
            scrollbar-width: none; /* Firefox */
        }
        .slider::-webkit-scrollbar { display: none; } /* Chrome/Safari */

        .slide-img {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            scroll-snap-align: center;
        }

        /* å³ä¸Šè§’å¼µæ•¸è¨ˆæ•¸å™¨ (1/3) */
        .page-counter {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
        }

        /* --- Actions: æ„›å¿ƒã€ç•™è¨€ã€å°åœ“é» --- */
        .action-bar {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .left-actions {
            display: flex;
            gap: 16px;
        }

        .action-icon {
            width: 24px;
            height: 24px;
            stroke: #000;
            fill: none;
            stroke-width: 2;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .action-icon:active { transform: scale(0.9); }

        /* æ„›å¿ƒè¢«é»æ“Šå¾Œçš„æ¨£å¼ */
        .heart-filled {
            fill: #ED4956;
            stroke: #ED4956;
            animation: pop 0.3s ease-out;
        }
        @keyframes pop { 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

        /* ä¸­é–“çš„å°åœ“é» (Pagination Dots) */
        .dots {
            display: flex;
            gap: 4px;
            position: absolute; /* çµ•å°å®šä½è®“å®ƒç½®ä¸­ */
            left: 50%;
            transform: translateX(-50%);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.2);
            transition: background-color 0.2s;
        }
        .dot.active { background-color: #0089FF; /* IG çš„è—è‰² */ }


        /* --- Likes & Comments --- */
        .likes-section {
            padding: 0 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }

        .like-avatar {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        /* --- ç•™è¨€å€ (åŒ…å«ä½œè€…ç™¼æ–‡) --- */
        .comments-section {
            padding: 0 15px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .comment-row {
            font-size: 14px;
            line-height: 1.4;
        }

        .comment-user {
            font-weight: 700;
            margin-right: 5px;
        }

        .comment-text {
            color: #111;
        }
        
        .timestamp {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            padding: 0 15px;
            text-transform: uppercase;
        }

        /* è¼‰å…¥ä¸­/ç„¡è³‡æ–™æç¤º */
        #status-msg {
            text-align: center;
            margin-top: 50px;
            color: #888;
            font-size: 14px;
        }

    </style>
</head>
<body>

    <div id="dynamic-feed"></div>

    <div id="status-msg">Loading memories...</div>

    <script>
        // --- 1. è³‡æ–™åº«é€£ç·š (IndexedDB) ---
        // é€™æ˜¯è·Ÿä¹‹å‰ã€Œé¦–é ã€èˆ‡ã€Œæ—¥æ›†ã€å®Œå…¨ä¸€æ¨£çš„è¨­å®šï¼Œç¢ºä¿èƒ½æŠ“åˆ°åŒä¸€ä»½è³‡æ–™
        const dbName = "MemoriesDB";
        const storeName = "photos";
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                };
            });
        }

        function getAllMemories() {
            return new Promise((resolve) => {
                if (!db) return resolve({});
                const tx = db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get("all_photos");
                req.onsuccess = (e) => resolve(e.target.result || {});
                req.onerror = () => resolve({});
            });
        }

        // --- 2. æ¸²æŸ“è²¼æ–‡é‚è¼¯ ---
        async function renderFeed() {
            await initDB();
            const memories = await getAllMemories();
            const feedContainer = document.getElementById('dynamic-feed');
            const statusMsg = document.getElementById('status-msg');

            // æ¸…ç©ºå®¹å™¨
            feedContainer.innerHTML = '';

            // å–å¾—æ‰€æœ‰æ—¥æœŸä¸¦æ’åº (æ–°çš„æ—¥æœŸåœ¨ä¸Šé¢)
            const sortedDates = Object.keys(memories).sort((a, b) => {
                return new Date(b.replace(/-/g, '/')) - new Date(a.replace(/-/g, '/'));
            });

            if (sortedDates.length === 0) {
                statusMsg.innerHTML = "No photos found.<br>Go to Home or Calendar to upload first.";
                return;
            } else {
                statusMsg.style.display = 'none';
            }

            // é‡å°æ¯ä¸€å¤©ç”¢ç”Ÿä¸€ç¯‡è²¼æ–‡
            sortedDates.forEach(dateKey => {
                const photos = memories[dateKey]; // é€™æ˜¯ä¸€å€‹åŒ…å«ç…§ç‰‡ Base64 çš„é™£åˆ—
                if (!photos || photos.length === 0) return;

                // ç”¢ç”Ÿå”¯ä¸€çš„ ID (ç”¨æ—¥æœŸå­—ä¸²å»é™¤ç¬¦è™Ÿ)
                const postId = dateKey.replace(/-/g, '');
                
                // è½‰æ›æ—¥æœŸæ ¼å¼ (ä¾‹: 2024-12-25 -> December 25, 2024)
                const dateObj = new Date(dateKey.replace(/-/g, '/'));
                const dateString = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                // 1. æº–å‚™åœ–ç‰‡ HTML (Slider)
                let slidesHtml = '';
                let dotsHtml = '';
                
                photos.forEach((photoBase64, index) => {
                    slidesHtml += `<img src="${photoBase64}" class="slide-img">`;
                    // åªæœ‰ç•¶ç…§ç‰‡å¤§æ–¼1å¼µæ™‚æ‰éœ€è¦ç”Ÿæˆ active ç‹€æ…‹çš„é‚è¼¯
                    if (photos.length > 1) {
                        dotsHtml += `<div class="dot ${index === 0 ? 'active' : ''}"></div>`;
                    }
                });

                // 2. æº–å‚™è¨ˆæ•¸å™¨ HTML (å¦‚æœåªæœ‰ä¸€å¼µåœ–å°±ä¸é¡¯ç¤º)
                const counterHtml = photos.length > 1 ? 
                    `<div class="page-counter" id="counter-${postId}">1/${photos.length}</div>` : '';

                // 3. çµ„åˆå®Œæ•´çš„ Post HTML (ä½¿ç”¨ä½ åŸæœ¬çš„ Class)
                const postHtml = `
                    <div class="post">
                        <div class="post-header">
                            <div class="user-info">
                                <img src="https://i.pravatar.cc/150?img=12" class="avatar">
                                <div class="user-text">
                                    <div class="username-row">
                                        <span class="username">My Memory</span>
                                        <svg class="bell-icon" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                                    </div>
                                    <span class="location">${dateString}</span>
                                </div>
                            </div>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="more-btn"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </div>

                        <div class="image-container">
                            ${counterHtml}
                            <div class="slider" id="slider-${postId}" onscroll="updateDots('${postId}', ${photos.length})">
                                ${slidesHtml}
                            </div>
                        </div>

                        <div class="action-bar">
                            <div class="left-actions">
                                <svg class="action-icon" onclick="toggleHeart(this)" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <svg class="action-icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                            </div>
                            
                            <div class="dots" id="dots-${postId}">
                                ${dotsHtml}
                            </div>

                            <div style="width:24px;"></div> 
                        </div>

                        <div class="likes-section">
                            <img src="https://i.pravatar.cc/150?img=60" class="like-avatar">
                            <span>Liked by <b>you</b> and <b>others</b></span>
                        </div>

                        <div class="comments-section">
                            <div class="comment-row">
                                <span class="comment-user">My Memory</span>
                                <span class="comment-text">Uploaded photos from ${dateString} ğŸ“¸</span>
                            </div>
                        </div>
                        <div class="timestamp">${dateKey}</div>
                    </div>
                `;

                feedContainer.insertAdjacentHTML('beforeend', postHtml);
            });
        }

        // --- 3. äº’å‹•åŠŸèƒ½ (æ„›å¿ƒã€è¼ªæ’­æ›´æ–°) ---
        
        function toggleHeart(el) {
            el.classList.toggle('heart-filled');
        }

        // é€™è£¡ç¨å¾®ä¿®æ”¹äº†ä¸€ä¸‹åŸæœ¬çš„ updateDotsï¼Œå› ç‚ºç¾åœ¨æ¯å€‹ Slider éƒ½æœ‰ç¨ç‰¹çš„ ID
        function updateDots(postId, totalPhotos) {
            const slider = document.getElementById(`slider-${postId}`);
            const dotsContainer = document.getElementById(`dots-${postId}`);
            const counter = document.getElementById(`counter-${postId}`);
            
            if(!slider) return;

            const scrollLeft = slider.scrollLeft;
            const width = slider.clientWidth;
            
            // è¨ˆç®—ç¾åœ¨åœ¨ç¬¬å¹¾å¼µ
            const index = Math.round(scrollLeft / width);

            // æ›´æ–°å³ä¸Šè§’æ•¸å­—
            if(counter) {
                counter.innerText = `${index + 1}/${totalPhotos}`;
            }

            // æ›´æ–°åœ“é» active ç‹€æ…‹
            if(dotsContainer) {
                const dots = dotsContainer.children;
                for (let i = 0; i < dots.length; i++) {
                    if (i === index) {
                        dots[i].classList.add('active');
                    } else {
                        dots[i].classList.remove('active');
                    }
                }
            }
        }

        // åˆå§‹åŒ–
        renderFeed();

    </script>
</body>
</html>
