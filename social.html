<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Feed</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š (ä¿ç•™åŸæ¨£) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #F3ECE5; color: #000; padding-bottom: 80px; }
        body::-webkit-scrollbar { display: none; }

        /* --- 2. è²¼æ–‡å¡ç‰‡ --- */
        .post { background-color: #F3ECE5; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        /* --- Header --- */
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; } /* å¢åŠ  cursor pointer */
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(0,0,0,0.1); background-color: #ddd; }
        .user-text { display: flex; flex-direction: column; }
        .username-row { display: flex; align-items: center; gap: 3px; }
        .username { font-weight: 700; font-size: 14px; color: #000; }
        .bell-icon { color: #E03E3E; }
        .location { font-size: 11px; color: #555; }
        .more-btn { color: #000; cursor: pointer; }

        /* --- Slider --- */
        .image-container { position: relative; width: 100%; aspect-ratio: 4/5; overflow: hidden; background-color: #e0d5cc; }
        .slider { display: flex; width: 100%; height: 100%; overflow-x: scroll; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .slider::-webkit-scrollbar { display: none; }
        .slide-img { flex: 0 0 100%; width: 100%; height: 100%; object-fit: cover; scroll-snap-align: center; }
        .page-counter { position: absolute; top: 15px; right: 15px; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; pointer-events: none; }

        /* --- Actions --- */
        .action-bar { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .left-actions { display: flex; gap: 16px; }
        .action-icon { width: 24px; height: 24px; stroke: #000; fill: none; stroke-width: 2; cursor: pointer; transition: transform 0.1s; }
        .action-icon:active { transform: scale(0.9); }
        .heart-filled { fill: #ED4956; stroke: #ED4956; animation: pop 0.3s ease-out; }
        @keyframes pop { 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
        .dots { display: flex; gap: 4px; position: absolute; left: 50%; transform: translateX(-50%); }
        .dot { width: 6px; height: 6px; border-radius: 50%; background-color: rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .dot.active { background-color: #0089FF; }

        /* --- Likes & Comments Display --- */
        .likes-section { padding: 0 15px; font-size: 13px; display: flex; align-items: center; gap: 5px; margin-bottom: 8px; }
        .like-avatar { width: 16px; height: 16px; border-radius: 50%; object-fit: cover; }
        
        .comments-section { padding: 0 15px; display: flex; flex-direction: column; gap: 4px; }
        .comment-row { font-size: 14px; line-height: 1.4; display: flex; gap: 6px; } /* å¾®èª¿ä½ˆå±€ */
        .comment-user { font-weight: 700; white-space: nowrap; }
        .comment-text { color: #111; word-break: break-word; }
        .timestamp { font-size: 10px; color: #888; margin-top: 4px; padding: 0 15px; text-transform: uppercase; }
        
        #status-msg { text-align: center; margin-top: 50px; color: #888; font-size: 14px; }

        /* --- [æ–°å¢] ç•™è¨€è¼¸å…¥æ¡†å€åŸŸæ¨£å¼ --- */
        .add-comment-section {
            display: none; /* é è¨­éš±è— */
            align-items: center;
            padding: 10px 15px 0 15px;
            margin-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.05);
            animation: slideDown 0.2s ease-out;
        }

        /* é¡¯ç¤ºæ™‚çš„å‹•ç•« */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .my-avatar-small {
            width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; object-fit: cover; border: 1px solid rgba(0,0,0,0.1);
        }

        .comment-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 8px 0;
            outline: none;
            color: #000;
        }
        
        .comment-input::placeholder { color: #999; }

        .post-btn {
            color: #9C7C66; /* IG è—è‰² */
            font-weight: 600;
            font-size: 14px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-left: 8px;
        }

        /* ç•¶è¼¸å…¥æ¡†æœ‰æ–‡å­—æ™‚ï¼ŒæŒ‰éˆ•è®Šäº®ä¸”å¯é»æ“Š */
        .comment-input:not(:placeholder-shown) + .post-btn {
            opacity: 1;
            pointer-events: auto;
        }

    </style>
</head>
<body>

    <div id="dynamic-feed"></div>
    <div id="status-msg">Loading...</div>

    <input type="file" id="profile-upload" accept="image/*" style="display: none;">

    <script>
        // --- 1. è³‡æ–™åº«è¨­å®š (å‡ç´šç‰ˆæœ¬ç‚º 2) ---
        // æˆ‘å€‘å°‡ç‰ˆæœ¬è™Ÿæ”¹ç‚º 2ï¼Œä»¥ä¾¿æ–°å¢ç•™è¨€å’Œå€‹äººæª”æ¡ˆçš„å­˜å„²ç©ºé–“
        const dbName = "MemoriesDB";
        const storeName = "photos";      // å­˜ç…§ç‰‡
        const commentStore = "comments";  // å­˜ç•™è¨€ (æ–°å¢)
        const profileStore = "profile";   // å­˜å€‹äººè³‡æ–™ (æ–°å¢)
        let db;

        // é è¨­ä½¿ç”¨è€…è³‡æ–™ (å¦‚æœé‚„æ²’è¨­å®š)
        let currentUser = {
            name: "My Memory",
            avatar: "https://i.pravatar.cc/150?img=12"
        };

        function initDB() {
            return new Promise((resolve, reject) => {
                // version: 2
                const request = indexedDB.open(dbName, 2);

                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    // å¦‚æœé€™äº›å€‰åº«ä¸å­˜åœ¨ï¼Œå°±å»ºç«‹å®ƒå€‘
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                    if (!db.objectStoreNames.contains(commentStore)) db.createObjectStore(commentStore);
                    if (!db.objectStoreNames.contains(profileStore)) db.createObjectStore(profileStore);
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };

                request.onerror = (e) => reject(e);
            });
        }

        // é€šç”¨çš„è®€å–è³‡æ–™å‡½å¼
        function getData(store, key) {
            return new Promise((resolve) => {
                const tx = db.transaction([store], "readonly");
                const s = tx.objectStore(store);
                const req = s.get(key);
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = () => resolve(null);
            });
        }

        // é€šç”¨çš„å„²å­˜è³‡æ–™å‡½å¼
        function saveData(store, key, data) {
            return new Promise((resolve) => {
                const tx = db.transaction([store], "readwrite");
                const s = tx.objectStore(store);
                s.put(data, key);
                tx.oncomplete = () => resolve();
            });
        }

        // --- 2. ä½¿ç”¨è€…å€‹äººè³‡æ–™é‚è¼¯ ---
        
        async function loadProfile() {
            const profile = await getData(profileStore, "user_info");
            if (profile) {
                currentUser = profile;
            }
        }

        // é»æ“Šé ­åƒè§¸ç™¼ï¼šç·¨è¼¯åç¨±ä¸¦ä¸Šå‚³åœ–ç‰‡
        function editProfile() {
            const newName = prompt("Enter your username:", currentUser.name);
            if (newName) {
                currentUser.name = newName;
                // è§¸ç™¼æª”æ¡ˆé¸æ“‡å™¨
                document.getElementById('profile-upload').click();
            }
        }

        // ç›£è½åœ–ç‰‡ä¸Šå‚³
        document.getElementById('profile-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    // å£“ç¸®åœ–ç‰‡ä»¥ç¯€çœç©ºé–“ (ç°¡å–®ç¸®æ”¾)
                    compressImage(evt.target.result, 150, 0.8, async (base64) => {
                        currentUser.avatar = base64;
                        await saveData(profileStore, "user_info", currentUser);
                        // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æ‰€æœ‰é ­åƒ
                        renderFeed(); 
                    });
                };
                reader.readAsDataURL(file);
            } else {
                // å¦‚æœåªæ”¹åæ²’æ”¹åœ–ï¼Œä¹Ÿè¦å­˜
                saveData(profileStore, "user_info", currentUser).then(renderFeed);
            }
        });

        // ç°¡å–®çš„åœ–ç‰‡å£“ç¸® helper (é¿å…é ­åƒå¤ªå¤§å¡é “)
        function compressImage(base64Str, maxWidth, quality, callback) {
            const img = new Image();
            img.src = base64Str;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                callback(canvas.toDataURL('image/jpeg', quality));
            };
        }

        // --- 3. ç•™è¨€åŠŸèƒ½é‚è¼¯ ---

        // åˆ‡æ›é¡¯ç¤º/éš±è—ç•™è¨€è¼¸å…¥æ¡†
        function toggleCommentBox(postId) {
            const box = document.getElementById(`comment-box-${postId}`);
            const input = document.getElementById(`input-${postId}`);
            
            if (box.style.display === 'flex') {
                box.style.display = 'none';
            } else {
                box.style.display = 'flex';
                // è‡ªå‹•èšç„¦ï¼Œæ–¹ä¾¿æ‰‹æ©Ÿè¼¸å…¥
                setTimeout(() => input.focus(), 50); 
            }
        }

        // ç™¼é€ç•™è¨€
        async function postComment(postId, inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;

            // 1. å–å¾—èˆŠç•™è¨€
            let comments = await getData(commentStore, postId) || [];
            
            // 2. åŠ å…¥æ–°ç•™è¨€
            comments.push({
                user: currentUser.name,
                text: text,
                time: new Date().getTime() // å­˜æ™‚é–“æˆ³è¨˜
            });

            // 3. å­˜å›è³‡æ–™åº«
            await saveData(commentStore, postId, comments);

            // 4. æ¸…ç©ºè¼¸å…¥æ¡†
            input.value = '';

            // 5. æ›´æ–°ç•«é¢ä¸Šçš„ç•™è¨€åˆ—è¡¨
            renderCommentsList(postId, comments);
        }

        // æ¸²æŸ“å–®ä¸€è²¼æ–‡çš„ç•™è¨€åˆ—è¡¨
        function renderCommentsList(postId, comments) {
            const container = document.getElementById(`comments-list-${postId}`);
            let html = '';
            
            // é è¨­é¡¯ç¤ºä½œè€…çš„ä¸Šå‚³è¨Šæ¯
            // html += `<div class="comment-row"><span class="comment-user">${currentUser.name}</span><span class="comment-text">Shared memory ğŸ“¸</span></div>`;

            comments.forEach(c => {
                html += `
                <div class="comment-row">
                    <span class="comment-user">${c.user}</span>
                    <span class="comment-text">${c.text}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- 4. ä¸»æ¸²æŸ“é‚è¼¯ (Render Feed) ---

        async function renderFeed() {
            try {
                await initDB();
                await loadProfile(); // å…ˆè®€å–ä½¿ç”¨è€…çš„é ­åƒè³‡æ–™

                const memories = await getData(storeName, "all_photos") || {};
                const feedContainer = document.getElementById('dynamic-feed');
                const statusMsg = document.getElementById('status-msg');

                feedContainer.innerHTML = '';

                // æ—¥æœŸæ’åºï¼šæ–°çš„åœ¨ä¸Šé¢
                const sortedDates = Object.keys(memories).sort((a, b) => {
                    return new Date(b.replace(/-/g, '/')) - new Date(a.replace(/-/g, '/'));
                });

                if (sortedDates.length === 0) {
                    statusMsg.innerHTML = "No photos yet.<br>Go to Calendar to add memories.";
                    return;
                } else {
                    statusMsg.style.display = 'none';
                }

                for (const dateKey of sortedDates) {
                    const photos = memories[dateKey];
                    if (!photos || photos.length === 0) continue;

                    const postId = dateKey.replace(/-/g, ''); // ç”¢ç”Ÿå”¯ä¸€ ID
                    
                    // è®€å–è©²ç¯‡è²¼æ–‡çš„ç•™è¨€
                    const postComments = await getData(commentStore, postId) || [];

                    const dateObj = new Date(dateKey.replace(/-/g, '/'));
                    const dateString = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                    // åœ–ç‰‡ Slider
                    let slidesHtml = '';
                    let dotsHtml = '';
                    photos.forEach((photoBase64, index) => {
                        slidesHtml += `<img src="${photoBase64}" class="slide-img">`;
                        if (photos.length > 1) {
                            dotsHtml += `<div class="dot ${index === 0 ? 'active' : ''}"></div>`;
                        }
                    });
                    const counterHtml = photos.length > 1 ? `<div class="page-counter" id="counter-${postId}">1/${photos.length}</div>` : '';

                    // çµ„åˆ HTML
                    const postHtml = `
                        <div class="post">
                            <div class="post-header">
                                <div class="user-info" onclick="editProfile()" title="Change name & avatar">
                                    <img src="${currentUser.avatar}" class="avatar">
                                    <div class="user-text">
                                        <div class="username-row">
                                            <span class="username">${currentUser.name}</span>
                                        </div>
                                        <span class="location">${dateString}</span>
                                    </div>
                                </div>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="more-btn"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </div>

                            <div class="image-container">
                                ${counterHtml}
                                <div class="slider" id="slider-${postId}" onscroll="updateDots('${postId}', ${photos.length})">
                                    ${slidesHtml}
                                </div>
                            </div>

                            <div class="action-bar">
                                <div class="left-actions">
                                    <svg class="action-icon" onclick="toggleHeart(this)" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    
                                    <svg class="action-icon" onclick="toggleCommentBox('${postId}')" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                </div>
                                <div class="dots" id="dots-${postId}">${dotsHtml}</div>
                                <div style="width:24px;"></div> 
                            </div>

                            <div class="likes-section">
                                <img src="${currentUser.avatar}" class="like-avatar">
                                <span>Liked by <b>others</b></span>
                            </div>

                            <div class="comments-section" id="comments-list-${postId}">
                                <div class="comment-row">
                                    <span class="comment-user">${currentUser.name}</span>
                                    <span class="comment-text">Shared ${photos.length} photos ğŸ“¸</span>
                                </div>
                            </div>
                            
                            <div class="timestamp">POSTED ON ${dateKey}</div>

                            <div class="add-comment-section" id="comment-box-${postId}">
                                <img src="${currentUser.avatar}" class="my-avatar-small">
                                <input type="text" id="input-${postId}" class="comment-input" placeholder="Add a comment...">
                                <button class="post-btn" onclick="postComment('${postId}', 'input-${postId}')">Post</button>
                            </div>
                        </div>
                    `;

                    feedContainer.insertAdjacentHTML('beforeend', postHtml);
                    
                    // åˆå§‹è¼‰å…¥è©²ç¯‡ç•™è¨€
                    renderCommentsList(postId, postComments);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('status-msg').innerText = "Database Loading Error. Try closing other tabs.";
            }
        }

        // --- è¼”åŠ© UI åŠŸèƒ½ ---
        function toggleHeart(el) { el.classList.toggle('heart-filled'); }

        function updateDots(postId, totalPhotos) {
            const slider = document.getElementById(`slider-${postId}`);
            const dotsContainer = document.getElementById(`dots-${postId}`);
            const counter = document.getElementById(`counter-${postId}`);
            if(!slider) return;
            const index = Math.round(slider.scrollLeft / slider.clientWidth);
            if(counter) counter.innerText = `${index + 1}/${totalPhotos}`;
            if(dotsContainer) {
                const dots = dotsContainer.children;
                for (let i = 0; i < dots.length; i++) {
                    dots[i].classList.toggle('active', i === index);
                }
            }
        }

        // å•Ÿå‹•
        renderFeed();

    </script>
</body>
</html>
