<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Feed</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š (ä¿ç•™) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #F3ECE5; color: #000; padding-bottom: 80px; }
        body::-webkit-scrollbar { display: none; }

        /* --- 2. è²¼æ–‡å¡ç‰‡ --- */
        .post { background-color: #F3ECE5; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        /* --- Header --- */
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; } /* åŠ äº† cursor */
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(0,0,0,0.1); background: #ddd; }
        .user-text { display: flex; flex-direction: column; }
        .username-row { display: flex; align-items: center; gap: 3px; }
        .username { font-weight: 700; font-size: 14px; color: #000; }
        .bell-icon { color: #E03E3E; }
        .location { font-size: 11px; color: #555; }
        .more-btn { color: #000; cursor: pointer; }

        /* --- Slider --- */
        .image-container { position: relative; width: 100%; aspect-ratio: 4/5; overflow: hidden; background-color: #e0d5cc; }
        .slider { display: flex; width: 100%; height: 100%; overflow-x: scroll; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .slider::-webkit-scrollbar { display: none; }
        .slide-img { flex: 0 0 100%; width: 100%; height: 100%; object-fit: cover; scroll-snap-align: center; }
        .page-counter { position: absolute; top: 15px; right: 15px; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; pointer-events: none; }

        /* --- Actions --- */
        .action-bar { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .left-actions { display: flex; gap: 16px; }
        .action-icon { width: 24px; height: 24px; stroke: #000; fill: none; stroke-width: 2; cursor: pointer; transition: transform 0.1s; }
        .action-icon:active { transform: scale(0.9); }
        .heart-filled { fill: #ED4956; stroke: #ED4956; animation: pop 0.3s ease-out; }
        @keyframes pop { 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
        .dots { display: flex; gap: 4px; position: absolute; left: 50%; transform: translateX(-50%); }
        .dot { width: 6px; height: 6px; border-radius: 50%; background-color: rgba(0,0,0,0.2); transition: background-color 0.2s; }
        .dot.active { background-color: #0089FF; }

        /* --- Likes & Comments --- */
        .likes-section { padding: 0 15px; font-size: 13px; display: flex; align-items: center; gap: 5px; margin-bottom: 8px; }
        .like-avatar { width: 16px; height: 16px; border-radius: 50%; }
        
        .comments-section { padding: 0 15px; display: flex; flex-direction: column; gap: 4px; }
        .comment-row { font-size: 14px; line-height: 1.4; display: flex; gap: 5px; }
        .comment-user { font-weight: 700; white-space: nowrap; }
        .comment-text { color: #111; word-break: break-word; }
        .timestamp { font-size: 10px; color: #888; margin-top: 4px; padding: 0 15px; text-transform: uppercase; }
        #status-msg { text-align: center; margin-top: 50px; color: #888; font-size: 14px; }

        /* --- æ–°å¢ï¼šç•™è¨€è¼¸å…¥æ¡†æ¨£å¼ --- */
        .add-comment-section {
            display: flex;
            align-items: center;
            padding: 10px 15px 0 15px;
            margin-top: 5px;
            border-top: 1px solid #9C7C66;
        }
        .my-avatar-small {
            width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; object-fit: cover;
        }
        .comment-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 5px 0;
            outline: none;
        }
        .post-btn {
            color: #0095F6;
            font-weight: 600;
            font-size: 14px;
            border: none;
            background: transparent;
            cursor: pointer;
            opacity: 0.5;
            pointer-events: none;
        }
        .comment-input:not(:placeholder-shown) + .post-btn {
            opacity: 1;
            pointer-events: auto;
        }

    </style>
</head>
<body>

    <div id="dynamic-feed"></div>
    <div id="status-msg">Loading...</div>

    <input type="file" id="profile-upload" accept="image/*" style="display: none;">

    <script>
        // --- 1. è³‡æ–™åº«è¨­å®š (å‡ç´šç‰ˆæœ¬ç‚º 2) ---
        const dbName = "MemoriesDB";
        const storeName = "photos";     // å­˜ç…§ç‰‡
        const commentStore = "comments"; // å­˜ç•™è¨€ (æ–°)
        const profileStore = "profile";  // å­˜å€‹äººæª” (æ–°)
        let db;
        
        // ç›®å‰çš„ä½¿ç”¨è€…è³‡æ–™ (é è¨­å€¼)
        let currentUser = {
            name: "My Memory",
            avatar: "https://i.pravatar.cc/150?img=12"
        };

        function initDB() {
            return new Promise((resolve, reject) => {
                // æ³¨æ„ï¼šé€™è£¡ç‰ˆæœ¬è™Ÿæ”¹æˆäº† 2ï¼Œé€™æ¨£æ‰æœƒè§¸ç™¼ onupgradeneeded å»ºç«‹æ–°å€‰åº«
                const request = indexedDB.open(dbName, 2);
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    // å¦‚æœæ²’æœ‰ç…§ç‰‡åº«ï¼Œå»ºç«‹å®ƒ
                    if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
                    // å¦‚æœæ²’æœ‰ç•™è¨€åº«ï¼Œå»ºç«‹å®ƒ
                    if (!db.objectStoreNames.contains(commentStore)) db.createObjectStore(commentStore);
                    // å¦‚æœæ²’æœ‰å€‹äººæª”åº«ï¼Œå»ºç«‹å®ƒ
                    if (!db.objectStoreNames.contains(profileStore)) db.createObjectStore(profileStore);
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = (e) => reject(e);
            });
        }

        // --- 2. è³‡æ–™å­˜å–å‡½å¼ ---

        function getData(store, key) {
            return new Promise((resolve) => {
                const tx = db.transaction([store], "readonly");
                const s = tx.objectStore(store);
                const req = s.get(key);
                req.onsuccess = (e) => resolve(e.target.result);
                req.onerror = () => resolve(null);
            });
        }

        function saveData(store, key, data) {
            return new Promise((resolve) => {
                const tx = db.transaction([store], "readwrite");
                const s = tx.objectStore(store);
                s.put(data, key);
                tx.oncomplete = () => resolve();
            });
        }

        // è®€å–å€‹äººæª”æ¡ˆ
        async function loadProfile() {
            const profile = await getData(profileStore, "user_info");
            if (profile) {
                currentUser = profile;
            }
        }

        // ä¿®æ”¹å€‹äººæª”æ¡ˆ (é»æ“Šé ­åƒè§¸ç™¼)
        function editProfile() {
            const newName = prompt("Enter your username:", currentUser.name);
            if (newName) {
                currentUser.name = newName;
                // è§¸ç™¼ä¸Šå‚³é ­è²¼
                document.getElementById('profile-upload').click();
            }
        }

        // ç›£è½é ­è²¼ä¸Šå‚³
        document.getElementById('profile-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(evt) {
                    currentUser.avatar = evt.target.result; // Base64
                    // å­˜å…¥è³‡æ–™åº«
                    await saveData(profileStore, "user_info", currentUser);
                    // é‡æ–°æ¸²æŸ“é é¢
                    renderFeed();
                };
                reader.readAsDataURL(file);
            } else {
                // å¦‚æœåªæ”¹åæ²’æ”¹åœ–
                 saveData(profileStore, "user_info", currentUser).then(renderFeed);
            }
        });

        // --- 3. ç•™è¨€åŠŸèƒ½é‚è¼¯ ---

        async function addComment(postId, inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;

            // 1. è®€å–èˆŠç•™è¨€
            let comments = await getData(commentStore, postId) || [];
            
            // 2. åŠ å…¥æ–°ç•™è¨€
            comments.push({
                user: currentUser.name,
                text: text,
                time: new Date().toISOString()
            });

            // 3. å­˜å›è³‡æ–™åº«
            await saveData(commentStore, postId, comments);

            // 4. æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡æ–°æ¸²æŸ“ç•™è¨€å€
            input.value = '';
            renderCommentsSection(postId, comments);
        }

        function renderCommentsSection(postId, comments) {
            const container = document.getElementById(`comments-container-${postId}`);
            let html = '';
            // å›ºå®šé¡¯ç¤ºçš„ç¬¬ä¸€æ¢ (æ¨™é¡Œèªªæ˜)
            // html += `<div class="comment-row"><span class="comment-user">${currentUser.name}</span><span class="comment-text">My memory log ğŸ“¸</span></div>`;
            
            // æ¸²æŸ“è³‡æ–™åº«è£¡çš„ç•™è¨€
            comments.forEach(c => {
                html += `
                <div class="comment-row">
                    <span class="comment-user">${c.user}</span>
                    <span class="comment-text">${c.text}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- 4. ä¸»æ¸²æŸ“é‚è¼¯ ---

        async function renderFeed() {
            await initDB();
            await loadProfile(); // å…ˆè®€å–ä½¿ç”¨è€…è³‡æ–™

            const memories = await getData(storeName, "all_photos") || {};
            const feedContainer = document.getElementById('dynamic-feed');
            const statusMsg = document.getElementById('status-msg');

            feedContainer.innerHTML = '';

            const sortedDates = Object.keys(memories).sort((a, b) => {
                return new Date(b.replace(/-/g, '/')) - new Date(a.replace(/-/g, '/'));
            });

            if (sortedDates.length === 0) {
                statusMsg.innerHTML = "No photos yet.<br>Click the user avatar in a post to set your profile!";
                // ç‚ºäº†è®“ä½¿ç”¨è€…èƒ½è¨­å®š Profileï¼Œæˆ‘å€‘å³ä½¿æ²’ç…§ç‰‡ä¹Ÿè®“ä»–çŸ¥é“æ€éº¼æ“ä½œï¼Œæˆ–æ˜¯é€™è£¡ä½ å¯ä»¥æ”¾ä¸€å€‹å‡çš„ Demo
                return;
            } else {
                statusMsg.style.display = 'none';
            }

            for (const dateKey of sortedDates) {
                const photos = memories[dateKey];
                if (!photos || photos.length === 0) continue;

                const postId = dateKey.replace(/-/g, '');
                
                // è®€å–è©²è²¼æ–‡çš„ç•™è¨€
                const postComments = await getData(commentStore, postId) || [];

                const dateObj = new Date(dateKey.replace(/-/g, '/'));
                const dateString = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                // åœ–ç‰‡è¼ªæ’­ HTML
                let slidesHtml = '';
                let dotsHtml = '';
                photos.forEach((photoBase64, index) => {
                    slidesHtml += `<img src="${photoBase64}" class="slide-img">`;
                    if (photos.length > 1) {
                        dotsHtml += `<div class="dot ${index === 0 ? 'active' : ''}"></div>`;
                    }
                });

                const counterHtml = photos.length > 1 ? `<div class="page-counter" id="counter-${postId}">1/${photos.length}</div>` : '';

                const postHtml = `
                    <div class="post">
                        <div class="post-header">
                            <div class="user-info" onclick="editProfile()" title="Click to edit profile">
                                <img src="${currentUser.avatar}" class="avatar">
                                <div class="user-text">
                                    <div class="username-row">
                                        <span class="username">${currentUser.name}</span>
                                    </div>
                                    <span class="location">${dateString}</span>
                                </div>
                            </div>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="more-btn"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </div>

                        <div class="image-container">
                            ${counterHtml}
                            <div class="slider" id="slider-${postId}" onscroll="updateDots('${postId}', ${photos.length})">
                                ${slidesHtml}
                            </div>
                        </div>

                        <div class="action-bar">
                            <div class="left-actions">
                                <svg class="action-icon" onclick="toggleHeart(this)" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <svg class="action-icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                            </div>
                            <div class="dots" id="dots-${postId}">${dotsHtml}</div>
                            <div style="width:24px;"></div> 
                        </div>

                        <div class="likes-section">
                            <img src="${currentUser.avatar}" class="like-avatar">
                            <span>Liked by <b>others</b></span>
                        </div>

                        <div class="comments-section" id="comments-container-${postId}">
                            <div class="comment-row">
                                <span class="comment-user">${currentUser.name}</span>
                                <span class="comment-text">Uploaded ${photos.length} photos ğŸ“¸</span>
                            </div>
                            </div>
                        
                        <div class="timestamp">POSTED ON ${dateKey}</div>

                        <div class="add-comment-section">
                            <img src="${currentUser.avatar}" class="my-avatar-small">
                            <input type="text" id="input-${postId}" class="comment-input" placeholder="Add a comment...">
                            <button class="post-btn" onclick="addComment('${postId}', 'input-${postId}')">Post</button>
                        </div>
                    </div>
                `;

                feedContainer.insertAdjacentHTML('beforeend', postHtml);
                // åˆå§‹æ¸²æŸ“ç•™è¨€
                renderCommentsSection(postId, postComments);
            }
        }

        function toggleHeart(el) { el.classList.toggle('heart-filled'); }

        function updateDots(postId, totalPhotos) {
            const slider = document.getElementById(`slider-${postId}`);
            const dotsContainer = document.getElementById(`dots-${postId}`);
            const counter = document.getElementById(`counter-${postId}`);
            if(!slider) return;
            const index = Math.round(slider.scrollLeft / slider.clientWidth);
            if(counter) counter.innerText = `${index + 1}/${totalPhotos}`;
            if(dotsContainer) {
                const dots = dotsContainer.children;
                for (let i = 0; i < dots.length; i++) {
                    dots[i].classList.toggle('active', i === index);
                }
            }
        }

        // åˆå§‹åŒ–
        renderFeed();

    </script>
</body>
</html>
