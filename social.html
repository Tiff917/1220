<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Social Feed</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #262626; 
            overflow-x: hidden; /* é˜²æ­¢å·¦å³æ»‘å‹• */
        }
        /* éš±è—æ²è»¸ */
        body::-webkit-scrollbar { display: none; }

        /* --- 2. é ‚éƒ¨å°è¦½åˆ— --- */
        .nav-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.98);
            border-bottom: 1px solid #efefef;
            padding: 0 16px;
            display: flex; justify-content: space-between; align-items: center;
            height: 54px; /* IG æ¨™æº–é«˜åº¦ */
        }
        .app-logo { 
            font-weight: 700; font-size: 22px; 
            font-family: 'Segoe UI', cursive; /* é€™è£¡å¯ä»¥æ›æˆä½ å–œæ­¡çš„å­—é«” */
            letter-spacing: -0.5px;
        }
        /* ç™¼æ–°è²¼æ–‡çš„æŒ‰éˆ• (+) */
        .new-post-btn { text-decoration: none; color: #262626; display: flex; align-items: center;}

        /* --- 3. å‹•æ…‹ç‰†å®¹å™¨ --- */
        #feed-container { width: 100%; margin: 0; padding-bottom: 80px; }

        /* è²¼æ–‡å¡ç‰‡ */
        .post-card { background: white; border-bottom: 1px solid #efefef; margin-bottom: 10px; padding-bottom: 10px; }

        /* è²¼æ–‡é ­éƒ¨ (é ­åƒã€åå­—) */
        .post-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(0,0,0,0.1); }
        .username { font-weight: 600; font-size: 14px; text-decoration: none; color: #262626; }
        .location { font-size: 12px; color: #262626; display: block; }

        /* åœ–ç‰‡è¼ªæ’­å€ */
        .media-container { position: relative; width: 100%; aspect-ratio: 1 / 1; background: #fafafa; }
        .slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider::-webkit-scrollbar { display: none; }
        .slide-item { flex: 0 0 100%; width: 100%; height: 100%; scroll-snap-align: start; }
        .slide-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* å³ä¸Šè§’å¼µæ•¸ (1/3) */
        .image-counter {
            position: absolute; top: 14px; right: 14px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 4px 10px; border-radius: 14px;
            font-size: 12px; font-weight: 600;
            display: none; pointer-events: none;
        }

        /* æŒ‰è®šã€ç•™è¨€å€å¡Š */
        .action-bar { padding: 10px 14px; display: flex; align-items: center; position: relative; height: 44px; }
        .action-left { display: flex; gap: 16px; align-items: center; }
        .icon-btn { cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-svg { width: 24px; height: 24px; display: block; } 
        
        /* è¼ªæ’­å°åœ“é» */
        .pagination-dots { display: flex; gap: 4px; position: absolute; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #dbdbdb; transition: background 0.2s; }
        .dot.active { background: #bfa093; /* æ”¹æˆä½ è¦çš„é¡è‰² */ }

        /* æ–‡å­—å…§å®¹å€ */
        .post-content { padding: 0 14px; font-size: 14px; }
        .likes-count { font-weight: 600; margin-bottom: 8px; display: block; }
        .comments-preview { display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px; }
        .comment-row { line-height: 1.4; word-wrap: break-word; margin-bottom: 4px; }
        .comment-user { font-weight: 600; margin-right: 5px; }
        .timestamp { font-size: 10px; color: #8e8e8e; text-transform: uppercase; margin-bottom: 12px; display: block; }

        /* å¿«é€Ÿç•™è¨€æ¡† */
        .add-comment-section {
            display: flex; align-items: center; padding-top: 10px; border-top: 1px solid #efefef; margin-top: 5px;
        }
        .user-avatar-small { width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .comment-input { flex: 1; border: none; font-size: 14px; padding: 5px 0; background: transparent; }
        .comment-input::placeholder { color: #8e8e8e; }
        .post-btn {
            color: #bfa093; /* æ”¹æˆä½ è¦çš„é¡è‰² */
            font-weight: 600; font-size: 14px; 
            border: none; background: none; cursor: pointer;
            padding-left: 10px; opacity: 0.5; pointer-events: none; 
        }
        .post-btn.active { opacity: 1; pointer-events: auto; }

        /* --- 4. å…¨è¢å¹•ç•™è¨€é é¢ (Overlay) --- */
        #comment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #comment-overlay.open { transform: translateX(0); }

        .overlay-header {
            height: 50px; border-bottom: 1px solid #dbdbdb;
            display: flex; align-items: center; padding: 0 16px;
            font-weight: 600; font-size: 16px; justify-content: space-between;
        }
        .back-btn { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;}
        .overlay-content { flex: 1; overflow-y: auto; padding: 16px; }
        
        .caption-block { display: flex; gap: 12px; padding-bottom: 12px; border-bottom: 1px solid #efefef; margin-bottom: 12px; }
        .caption-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover;}
        .caption-text-area { flex: 1; font-size: 14px; line-height: 1.4; }
        
        .overlay-footer {
            border-top: 1px solid #dbdbdb; padding: 10px 16px;
            display: flex; align-items: center; background: white;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
        }
        
        /* ç„¡è³‡æ–™æ™‚çš„æç¤º */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; color: #8e8e8e; gap: 15px;
        }
        .empty-icon { font-size: 40px; opacity: 0.3; }
    </style>
</head>
<body>

    <div id="feed-container">
        <div class="empty-state" id="loading-msg">
            <div class="empty-icon">ğŸ“·</div>
            <div>Loading your moments...</div>
        </div>
    </div>

    <div id="comment-overlay">
        <div class="overlay-header">
            <div class="back-btn" onclick="closeCommentPage()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </div>
            <span>Comments</span>
            <div style="width: 30px;"></div>
        </div>
        
        <div class="overlay-content" id="overlay-scroll-area">
            </div>

        <div class="overlay-footer">
            <img src="" class="user-avatar-small" id="overlay-my-avatar">
            <input type="text" class="comment-input" id="overlay-input" placeholder="Add a comment..." autocomplete="off">
            <button class="post-btn" id="overlay-post-btn">Post</button>
        </div>
    </div>

    <script>
        // --- 1. ä½¿ç”¨è€…è³‡è¨Š ---
        const storedName = localStorage.getItem('myProfileName');
        const storedAvatar = localStorage.getItem('myProfileAvatar');

        const currentUser = {
            name: storedName ? storedName : "Guest",
            avatar: storedAvatar ? storedAvatar : "https://i.pravatar.cc/150?img=68"
        };
        document.getElementById('overlay-my-avatar').src = currentUser.avatar;

        // --- 2. è³‡æ–™åº«è¨­å®š ---
        const dbName = "MemoriesDB";
        const storeName = "posts_timeline"; // å°æ‡‰ edit.html çš„æ–°åç¨±
        let db;
        let postsData = []; 

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 2); // â˜…â˜…â˜… ç‰ˆæœ¬è™Ÿ 2 â˜…â˜…â˜…
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e);
            });
        }

        function getTimeline() {
            return new Promise((resolve) => {
                if (!db) return resolve([]);
                // é˜²å‘†ï¼šå¦‚æœè³‡æ–™åº«å‰›å‡ç´šï¼Œå¯èƒ½é‚„æ²’æœ‰ objectStore
                if (!db.objectStoreNames.contains(storeName)) return resolve([]);
                
                const tx = db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get("feed_data");
                req.onsuccess = (e) => resolve(e.target.result || []);
                req.onerror = () => resolve([]);
            });
        }

        // --- 3. æ ¸å¿ƒï¼šè¼‰å…¥è²¼æ–‡ ---
        async function loadAndRender() {
            try {
                await initDB();
                
                // ç›´æ¥å–å¾—åˆ—è¡¨ (é€™å·²ç¶“æ˜¯æŒ‰æ™‚é–“æ’åºå¥½çš„ Post Objects)
                let timeline = await getTimeline();

                if (timeline.length === 0) {
                    document.getElementById('loading-msg').innerHTML = `
                        <div class="empty-icon">ğŸ“·</div>
                        <div>No posts yet.</div>
                        <div style="font-size:12px; margin-top:5px;">Tap + to share your moments!</div>
                    `;
                    return;
                }

                // è™•ç†è³‡æ–™ (è£œä¸Šé è¨­çš„ä½œè€…å…§æ–‡)
                postsData = timeline.map(post => {
                    // å¦‚æœé€™å€‹è²¼æ–‡é‚„æ²’æœ‰ç•™è¨€ (å‰›ç™¼ä½ˆæ™‚)ï¼Œè‡ªå‹•å¹«å®ƒåŠ ä¸€å€‹ä½œè€…çš„æ—¥æœŸæ¨™è¨˜ç•¶ä½œå…§æ–‡
                    if (!post.comments || post.comments.length === 0) {
                        post.comments = [
                            { user: currentUser.name, text: `Memory from ${post.dateString} âœ¨` }
                        ];
                    }
                    // è£œä¸Š user è³‡è¨Š (å› ç‚º edit.html æ²’å­˜ user è³‡æ–™ï¼Œé€™è£¡å‹•æ…‹è£œä¸Šã€Œæˆ‘ã€)
                    // å¦‚æœæœªä¾†æœ‰å¤šäººåŠŸèƒ½ï¼Œé€™è£¡è¦æ”¹è®€ post.user
                    post.user = currentUser; 
                    
                    // é¡¯ç¤ºç”¨çš„æ™‚é–“å­—ä¸² (å¦‚æœæ˜¯ä¸€å¤©å…§çš„ï¼Œå¯ä»¥æ”¹æˆ 'Just now' æˆ– '2 hours ago'ï¼Œé€™è£¡å…ˆç°¡å–®é¡¯ç¤ºæ—¥æœŸ)
                    post.time = post.dateString; 

                    return post;
                });

                renderPosts();

            } catch (e) {
                console.error("Loading error:", e);
                document.getElementById('loading-msg').textContent = "Failed to load feed.";
            }
        }

        // --- 4. æ¸²æŸ“é‚è¼¯ (ä¿æŒä¸è®Š) ---
        const feedContainer = document.getElementById('feed-container');
        const icons = {
            more: '<svg aria-label="More" color="#262626" fill="#262626" height="24" viewBox="0 0 24 24" width="24"><circle cx="12" cy="12" r="1.5"></circle><circle cx="6" cy="12" r="1.5"></circle><circle cx="18" cy="12" r="1.5"></circle></svg>',
            heartOutline: '<svg aria-label="Like" color="#262626" fill="#262626" height="24" viewBox="0 0 24 24" width="24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.956-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.622-3.067c.285-.253.571-.5.854-.747 2.465-2.143 5.015-4.36 5.015-7.97a6.985 6.985 0 0 0-6.792-6.218Z"></path></svg>',
            heartFilled: '<svg aria-label="Unlike" fill="#ed4956" height="24" viewBox="0 0 48 48" width="24"><path d="M34.6 3.1c-4.5 0-7.9 1.8-10.6 5.6-2.7-3.7-6.1-5.5-10.6-5.5C6 3.1 0 9.6 0 17.6c0 7.3 5.4 12 10.6 16.5.6.5 1.3 1.1 1.9 1.7l2.3 2c4.4 3.9 6.6 5.9 7.6 6.5.5.3 1.1.5 1.6.5s1.1-.2 1.6-.5c1-.6 2.8-2.2 7.8-6.8l2-1.8c.7-.6 1.3-1.2 2-1.7C42.7 29.6 48 25 48 17.6c0-8-6-14.5-13.4-14.5z"></path></svg>',
            comment: '<svg aria-label="Comment" fill="none" height="24" viewBox="0 0 24 24" width="24"><path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" stroke="black" stroke-linejoin="round" stroke-width="1.5"></path></svg>'
        };

        function renderPosts() {
            if (postsData.length === 0) return;

            feedContainer.innerHTML = postsData.map(post => {
                const imagesHtml = post.images.map(img => `<div class="slide-item"><img src="${img}"></div>`).join('');
                const dotsHtml = post.images.length > 1 ? `<div class="pagination-dots" id="dots-${post.id}">${post.images.map((_, i) => `<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>` : '';
                const counterDisplay = post.images.length > 1 ? 'block' : 'none';
                
                const authorComment = post.comments[0];
                const previewHtml = `<div class="comment-row"><span class="comment-user">${authorComment.user}</span><span class="comment-text">${authorComment.text}</span></div>`;
                const viewAllLink = post.comments.length > 1 ? `<div style="color:#8e8e8e; margin-bottom:4px; cursor:pointer;" onclick="openCommentPage(${post.id})">View all ${post.comments.length} comments</div>` : '';
                const initialHeart = post.isLiked ? icons.heartFilled : icons.heartOutline;

                return `
                <div class="post-card" id="post-${post.id}">
                    <div class="post-header">
                        <div class="user-info">
                            <img src="${post.user.avatar}" class="avatar">
                            <div><span class="username">${post.user.name}</span><span class="location">${post.time}</span></div>
                        </div>
                        <div class="icon-btn">${icons.more}</div>
                    </div>
                    <div class="media-container">
                        <div class="image-counter" id="counter-${post.id}" style="display:${counterDisplay}">1/${post.images.length}</div>
                        <div class="slider" onscroll="updateSlider(${post.id})" id="slider-${post.id}">${imagesHtml}</div>
                    </div>
                    <div class="action-bar">
                        <div class="action-left">
                            <div class="icon-btn" onclick="toggleLike(this)">${initialHeart}</div>
                            <div class="icon-btn" onclick="openCommentPage(${post.id})">${icons.comment}</div>
                        </div>
                        ${dotsHtml}
                    </div>
                    <div class="post-content">
                        <span class="likes-count">${post.likes.toLocaleString()} likes</span>
                        <div class="comments-preview">${previewHtml}</div>
                        ${viewAllLink}
                        <div class="timestamp">${post.time}</div>
                        <div class="add-comment-section">
                            <img src="${currentUser.avatar}" class="user-avatar-small">
                            <input type="text" class="comment-input" id="input-${post.id}" placeholder="Add a comment..." autocomplete="off" oninput="checkInput(this, 'btn-${post.id}')" onkeypress="handleEnter(event, ${post.id}, 'input-${post.id}')">
                            <button class="post-btn" id="btn-${post.id}" onclick="postComment(${post.id}, 'input-${post.id}')">Post</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- 5. äº’å‹•åŠŸèƒ½ (é»è®šã€è¼ªæ’­) ---
        function toggleLike(btn) {
            const isFilled = btn.innerHTML.includes('fill="#ed4956"');
            btn.innerHTML = isFilled ? icons.heartOutline : icons.heartFilled;
        }

        function updateSlider(postId) {
            const slider = document.getElementById(`slider-${postId}`);
            const dotsContainer = document.getElementById(`dots-${postId}`);
            const counter = document.getElementById(`counter-${postId}`);
            if (!dotsContainer) return;
            const index = Math.round(slider.scrollLeft / slider.offsetWidth);
            Array.from(dotsContainer.children).forEach((dot, i) => dot.classList.toggle('active', i === index));
            counter.innerText = `${index + 1}/${dotsContainer.children.length}`;
        }

        // --- 6. ç•™è¨€ç³»çµ± (åŒ…å«å„²å­˜) ---
        let currentOpenPostId = null;

        function openCommentPage(postId) {
            currentOpenPostId = postId;
            const post = postsData.find(p => p.id === postId);
            const overlay = document.getElementById('comment-overlay');
            const contentArea = document.getElementById('overlay-scroll-area');
            
            const caption = post.comments[0]; 
            let html = `
                <div class="caption-block">
                    <img src="${post.user.avatar}" class="caption-avatar">
                    <div class="caption-text-area">
                        <span class="comment-user">${post.user.name}</span>
                        <span>${caption.text}</span>
                        <div style="font-size:12px; color:#8e8e8e; margin-top:4px;">${post.time}</div>
                    </div>
                </div>
                <div class="all-comments-list">
            `;
            
            for (let i = 1; i < post.comments.length; i++) {
                const c = post.comments[i];
                let avatarSrc = (c.user === currentUser.name) ? currentUser.avatar : `https://i.pravatar.cc/150?u=${c.user}`;
                html += `
                    <div class="comment-row" style="margin-bottom: 12px; display:flex; gap:12px;">
                        <img src="${avatarSrc}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                        <div style="font-size:14px;">
                            <span class="comment-user">${c.user}</span>
                            <span>${c.text}</span>
                        </div>
                    </div>
                `;
            }
            html += `</div>`;
            contentArea.innerHTML = html;
            overlay.classList.add('open'); 

            const input = document.getElementById('overlay-input');
            const btn = document.getElementById('overlay-post-btn');
            input.value = '';
            btn.classList.remove('active');
            btn.onclick = () => postCommentFromOverlay(postId);
            input.oninput = () => checkInput(input, 'overlay-post-btn');
            input.onkeypress = (e) => { if(e.key === 'Enter') postCommentFromOverlay(postId); };
        }

        function closeCommentPage() {
            document.getElementById('comment-overlay').classList.remove('open');
            currentOpenPostId = null;
            renderPosts();
        }

        function checkInput(inputEl, btnId) {
            const btn = document.getElementById(btnId);
            if (inputEl.value.trim().length > 0) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function handleEnter(e, postId, inputId) {
            if (e.key === 'Enter') postComment(postId, inputId);
        }

        // â˜…â˜…â˜… ç•™è¨€ä¸¦å­˜å›è³‡æ–™åº« â˜…â˜…â˜…
        async function saveCommentsToDB() {
            // postsData å·²ç¶“è¢«æ›´æ–°äº†ï¼Œæˆ‘å€‘æŠŠæ•´å€‹ postsData å­˜å›å»
            // æ³¨æ„ï¼šé€™è£¡å› ç‚º postsData çš„æ ¼å¼å’Œ DB è£¡çš„ä¸€æ¨£ï¼Œæ‰€ä»¥ç›´æ¥å­˜
            const tx = db.transaction([storeName], "readwrite");
            const store = tx.objectStore(storeName);
            store.put(postsData, "feed_data");
        }

        async function postComment(postId, inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;
            const post = postsData.find(p => p.id === postId);
            post.comments.push({ user: currentUser.name, text: text });
            input.value = '';
            renderPosts();
            await saveCommentsToDB(); // å„²å­˜è®Šæ›´
        }

        async function postCommentFromOverlay(postId) {
            const input = document.getElementById('overlay-input');
            const text = input.value.trim();
            if (!text) return;
            const post = postsData.find(p => p.id === postId);
            post.comments.push({ user: currentUser.name, text: text });
            openCommentPage(postId);
            await saveCommentsToDB(); // å„²å­˜è®Šæ›´
        }

        loadAndRender();

    </script>
</body>
</html>
